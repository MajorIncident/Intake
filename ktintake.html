<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KT Intake</title>

<!--
[contract] start
EDITING CONTRACT for ChatGPT & humans:
- Keep these anchors intact. Prefer unified diffs (*** Begin Patch / *** End Patch) that edit INSIDE the relevant anchors only.
- Do not remove tokens: {OBJECT} / {DEVIATION}.
- Keep function names/signatures for copy to ASCII intact.
- Avoid structural rewrites unless requested; keep single-file layout.
Anchors present:
  [styles] [vars] [header] [section:preface] [subtitle]
  [section:impact] [section:table]
  [script] [rows] [script:table-build] [script:preface-refs]
  [script:tokens] [script:init] [script:export] [script:storage] [script:toast]
[contract] end
-->

<!-- [styles] start -->
<style>
  /* [vars] start */
  :root{
    /* Apple-like daytime palette */
    --bg:#f5f7fb;
    --panel:#ffffff;
    --ink:#0c1220;
    --muted:#5b6475;
    --line:#e6eaf2;
    --band:#f6f8fc;
    --accent:#007aff;

    /* Layout */
    --qcol-w:10.5rem;     /* narrow KT Question column */
    --ta-fs:15px;         /* textarea font size */
    --ta-min-h:380px;     /* taller by default */
    --radius:14px;
    --shadow:0 8px 24px rgba(12,18,32,.08), 0 1px 0 rgba(255,255,255,.6) inset;
    --speed:.22s;
  }
  /* [vars] end */

  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
  }
  header{
    max-width:1240px; margin:22px auto 8px; padding:0 12px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  h1#docTitle{font-size:22px; font-weight:800; margin:0; letter-spacing:.1px; white-space:pre-wrap;}
  .subtle{color:var(--muted); font-size:12px;}
  .btn{
    appearance:none; border:1px solid var(--line); background:var(--accent); color:#fff;
    padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    transition:transform var(--speed), box-shadow var(--speed), border-color var(--speed);
    box-shadow:0 6px 18px rgba(0,122,255,.18);
  }
  .btn:hover{transform:translateY(-1px);}

  .wrap{max-width:1240px; margin:0 auto 40px; padding:0 12px;}
  h2#docSubtitle{margin:12px 0 8px; font-size:16px; font-weight:700; color:#2a3957; white-space:pre-wrap;}

  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:20px 22px 24px; margin:0 0 32px;
  }
  .card h3{
    margin:0 0 16px;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,ui-sans-serif;
    font-size:15px; font-weight:700; letter-spacing:.32px; text-transform:uppercase; color:#1d2845;
  }
  .preface-stack{display:flex; flex-direction:column;}
  .grid{ display:grid; gap:12px; }
  .grid.cols-2{ grid-template-columns:1fr 1fr; }
  .grid.cols-3{ grid-template-columns:1fr 1fr 1fr; }
  .field label{display:block; font-weight:700; margin-bottom:6px;}
  .field small{display:block; color:var(--muted); margin-top:4px;}
  .field textarea, .field input[type="text"]{
    width:100%; box-sizing:border-box;
    font:15px/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:12px 14px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  .field textarea{min-height:140px; resize:vertical;}
  .field input[type="text"]{height:44px;}
  .field textarea::placeholder, .field input::placeholder{color:#8b93a4;}
  .field textarea:focus, .field input:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#fff;}

  /* Impact strip */
  .impact h3{ margin:0 0 8px; font-size:14px; color:#2a3957; }

  /* Table */
  table{
    width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:var(--radius);
    background:var(--panel); border:1px solid var(--line); box-shadow:var(--shadow);
  }
  thead th{
    position:sticky; top:0; z-index:3;
    background:linear-gradient(180deg, #ffffff, #fafbfe);
    color:#0c1220; text-align:left; font-size:12px; letter-spacing:.4px;
    padding:12px; border-bottom:1px solid var(--line);
  }
  tbody td, tbody th{
    border-bottom:1px solid var(--line); vertical-align:top; padding:10px 8px; transition:background-color var(--speed);
  }
  tbody tr:last-child td, tbody tr:last-child th{border-bottom:0;}
  tbody tr:hover td, tbody tr:hover th{background-color:#fafbfe;}
  tbody th{
    width:var(--qcol-w); max-width:var(--qcol-w); min-width:var(--qcol-w);
    white-space:normal; word-break:break-word; font-weight:700; color:#0c1220;
  }
  .band th{
    padding:12px; font-weight:800; color:#2a3957;
    background:linear-gradient(180deg, var(--band), #ffffff);
    border-top:1px solid var(--line); border-bottom:1px solid var(--line);
  }
  .band th span{opacity:.85; font-weight:600; color:#6b768a}
  textarea.tableta{
    width:100%; min-height:var(--ta-min-h); resize:vertical; box-sizing:border-box;
    font:var(--ta-fs)/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:12px 14px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  textarea.tableta::placeholder{color:#8b93a4;}
  textarea.tableta:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#ffffff;}

  /* Toast */
  .toast{
    position:fixed; right:18px; bottom:18px; background:#0f1a10; color:#dff5e1; border:1px solid #164f19;
    padding:10px 12px; border-radius:12px; opacity:0; transform:translateY(10px); transition:.25s; pointer-events:none; box-shadow:var(--shadow);
  }
  .toast.show{opacity:1; transform:translateY(0);}
</style>
<!-- [styles] end -->
</head>
<body>
  <!-- [header] start -->
  <header>
    <h1 id="docTitle">KT Intake — add Specific Object & What’s happening now to set the title</h1>
    <button class="btn" id="copyBtn">Copy as ASCII</button>
  </header>
  <!-- [header] end -->

  <div class="wrap">
    <!-- [section:preface] start -->
    <section class="preface-stack">
      <div class="card">
        <h3>Problem Summary</h3>
        <div class="grid">
          <div class="field">
            <label for="oneLine">In one sentence, what is broken for you right now?</label>
            <textarea id="oneLine" placeholder="e.g., Checkout API returns 500 for US customers using Apple Pay."></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Evidence &amp; Object</h3>
        <div class="grid cols-2">
          <div class="field">
            <label for="proof">What proves a deviation exists?</label>
            <small>Examples: alerts fired, metric spikes/drops, log lines, screenshots, error codes, reproducible steps.</small>
            <textarea id="proof" placeholder="PagerDuty P1 at 13:04Z; error_rate{svc=checkout} rose from 0.2%→12%; logs show ERR-1298 &quot;token invalid&quot;; reproduce with POST /v1/checkout ..."></textarea>
          </div>
          <div class="field">
            <label for="objectPrefill">What is the specific object being affected?</label>
            <small>Service/API, container/VM/function/module/method, datastore/volume/bucket/table, network element, identity/policy/role, pipeline/job.</small>
            <textarea id="objectPrefill" placeholder="e.g., Service: checkout-api (image sha256:...), in cluster prod-us-east-1, namespace commerce."></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Baseline vs Current</h3>
        <div class="grid cols-2">
          <div class="field">
            <label id="labelHealthy" for="healthy">What does healthy look like here?</label>
            <small>State an SLI/SLO baseline for the same subject: latency p95, error rate %, throughput, success %, CPU/mem, queue depth, etc.</small>
            <textarea id="healthy" placeholder="e.g., p95 latency &lt; 250ms, error rate &lt; 0.5%, 300 rps sustained, no retries above baseline."></textarea>
          </div>
          <div class="field">
            <label id="labelNow" for="now">What is happening now?</label>
            <small>Current measurements vs the same baseline (same metrics as above) or what users are experiencing.</small>
            <textarea id="now" placeholder="e.g., p95 1.8s, error rate 12–18%, retries 30/s, saturation ~80%, users see 500 after auth."></textarea>
          </div>
        </div>
      </div>
    </section>
    <!-- [section:preface] end -->

    <!-- [subtitle] start -->
    <h2 id="docSubtitle">Describe Problem — awaiting Specific Object & What’s happening now…</h2>
    <!-- [subtitle] end -->

    <!-- [section:impact] start -->
    <div class="card impact">
      <h3>Impact</h3>
      <div class="grid cols-3">
        <div class="field">
          <label for="impactNow">Current Impact</label>
          <small>Who/what is affected now? Quantify: users/tenants/regions, transactions failing, SLI/SLO deltas (avail %, p95/p99, error %), data at risk (loss/corruption/exposure), workarounds.</small>
          <textarea id="impactNow" placeholder="e.g., 18% of US checkouts failing; ~$5–7k/min revenue at risk; PCI scope unaffected; manual retry mitigates for 50% of users."></textarea>
        </div>
        <div class="field">
          <label for="impactFuture">Future Impact</label>
          <small>If unresolved (1h/24h/7d), what happens? Blast radius growth, SLO/SLA breach, revenue/penalties, compliance, backlog/consumer lag, churn, on-call fatigue.</small>
          <textarea id="impactFuture" placeholder="e.g., SLO breach in 45m; cart abandonment ↑; SLA credits possible; backlog exceeds consumer capacity by EOD."></textarea>
        </div>
        <div class="field">
          <label for="impactTime">Timeframe</label>
          <small>Start & detection; duration so far; forecast; maint windows; deadlines; RTO/RPO.</small>
          <textarea id="impactTime" placeholder="Started 13:02Z, detected 13:04Z, ongoing 28m; likely until rollback; RTO 1h, RPO 0."></textarea>
        </div>
      </div>
    </div>
    <!-- [section:impact] end -->

    <!-- [section:table] start -->
    <p class="subtle">Use IS / IS NOT literally. Put <strong>Distinctions</strong> in Column 4 (one per line). Column 5 prompts “what changed…” for each distinction. Object &amp; Deviation auto-populate in prompts as you type.</p>

    <table id="ktTable" aria-label="KT IS / IS NOT intake table">
      <thead>
        <tr>
          <th scope="col">KT Question</th>
          <th scope="col">IS <span class="subtle">— facts only</span></th>
          <th scope="col">IS NOT <span class="subtle">— similar &amp; reasonable but not</span></th>
          <th scope="col">Distinctions <span class="subtle">— one per line</span></th>
          <th scope="col">Changes <span class="subtle">— mapped to distinctions</span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <!-- [section:table] end -->
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- [script] start -->
<script>
/* [rows] start */
/* =================== Core data & prompts =================== */
/* Use {OBJECT} / {DEVIATION} tokens anywhere you want auto-fill. */
const ROWS = [
  { band: "WHAT", note: "State & specify the problem (object + deviation)." },

  {
    q: "WHAT — Object (identity & build)",
    isPH: "What specific object(s) has the deviation?\n• Service/app/workload name\n• Version/image/commit/OS/patch level\n• Endpoint/protocol (e.g., POST /v1/...)\n• Dependencies (DB/cache/queue/API)\n• Env/stage (prod/stage/dev)",
    notPH:"Select items similar to the IS case, closely related, and that could reasonably show the deviation — but do not.\n• Same build in other node/AZ/cluster\n• Other tenants/namespaces\n• Other LB pool/pod/instance",
  },
  {
    q:"WHAT — Deviation (symptom & evidence)",
    isPH:"What is the specific deviation?\nWhat tells us the deviation exists?\n• Error text/code & timestamp\n• Key log line / trace span IDs\n• Health check/probe results\n• What should have happened vs what did",
    notPH:"Choose comparable symptoms you might reasonably expect—similar context as IS—but which are not observed.\n• No timeouts? No 5xx? No OOM?\n• No CPU/disk/network saturation",
  },

  { band: "WHERE", note: "Location in geography/topology and on the object." },

  {
    q:"WHERE — Geography / Topology (map pin)",
    isPH:"Where is {OBJECT} when {DEVIATION} is observed (geographically/topologically)?\n• Cloud/Region/AZ / VPC/Subnet\n• Hop that fails: client→edge/CDN→WAF/LB→mesh→app→DB",
    notPH:"Select locations/topology closely related to the IS location for {OBJECT} that could reasonably show {DEVIATION} — but do not.\n• Other Region/AZ/VPC\n• Other node pool/namespace\n• Other ISP/branch/site",
  },
  {
    q:"WHERE — On {OBJECT} (module / table / step)",
    isPH:"Where is {DEVIATION} on {OBJECT}?\n• Module/class/handler\n• Screen/step/endpoint\n• Table/index/partition / topic shard\n• Log file+line / span location",
    notPH:"Choose nearby modules/steps on {OBJECT} similar to the IS spot that could reasonably show {DEVIATION} — but do not.\n• Other layers/steps\n• Auth passes; reads OK vs writes fail",
  },

  { band: "WHEN", note: "Clock & calendar; since then; life-cycle moment (‘what changed’ lives here)." },

  {
    q:"WHEN — First seen (clock & calendar time)",
    isPH:"When was {DEVIATION} observed first for {OBJECT}? (date & time with timezone)\nHas it ever worked before?\nLast known good (build/commit + timestamp).",
    notPH:"Consider first-seen times closely related to the IS timeline for {OBJECT} that could reasonably have been first — but were not.",
  },
  {
    q:"WHEN — Since then (occurrences & pattern)",
    isPH:"Since first occurrence, when has {DEVIATION} been observed on/with {OBJECT}?\nList all windows with start/stop times.\nPattern: continuous / periodic / sporadic; bursts; top-of-hour; load/time correlation.",
    notPH:"Consider time windows/patterns similar to IS for {OBJECT} that reasonably could occur — but do not.",
  },
  {
    q:"WHEN — Life-cycle moment (history of {OBJECT})",
    isPH:"When, in {OBJECT}’s history or life cycle, was {DEVIATION} observed first?\n• Deploy/rollback/feature flag\n• Config/secret/cert rotation\n• Autoscale/startup/cache warm\n• GC/compaction/failover/rebalancing\nAlso: What changed near first occurrence or between IS and IS NOT?",
    notPH:"Consider adjacent life-cycle moments for {OBJECT} that could reasonably show {DEVIATION} — but do not.",
  },

  { band: "EXTENT", note: "Magnitude, severity, multiplicity, and trend." },

  {
    q:"EXTENT — Objects with deviation & trend",
    isPH:"How many {OBJECT}s have {DEVIATION}? What is the trend* in the number of objects? (*increasing/decreasing/stable)\n• Affected pods/hosts/tenants/users\n• Which versions/builds",
    notPH:"Pick comparable object sets (same family/versions/envs) for {OBJECT} that reasonably could be affected by {DEVIATION} — but are not.",
  },
  {
    q:"EXTENT — Size of a single deviation & trend",
    isPH:"What is the size of a single {DEVIATION} on {OBJECT}? (latency delta, error rate %, throughput/availability impact)\nWhat is the trend* in the size?",
    notPH:"Choose similar size metrics on {OBJECT} that could reasonably be worse — but are not.",
  },
  {
    q:"EXTENT — Instances per object & trend",
    isPH:"How many instances of {DEVIATION} occur on each {OBJECT}? (e.g., errors/min per instance)\nWhat is the trend* in the number of instances?",
    notPH:"Consider comparable instance counts/rates on {OBJECT} that reasonably could occur — but do not.",
  },
  {
    q:"EXTENT — Boundaries (crisp IS vs IS NOT)",
    isPH:"What portion of {OBJECT}’s surface is affected by {DEVIATION}?\n• Endpoints/roles/tenants/shards/regions/AZs\n• Only POST /v1/orders in AZ-a; only IPv6; only shard-3, etc.",
    notPH:"Identify close boundary neighbors around {OBJECT} that reasonably could be impacted by {DEVIATION} — but are not.",
  }
];
/* [rows] end */

/* [script:table-build] start */
/* =================== Build table & dynamic tokens =================== */
const tbody = document.getElementById('tbody');
const rowsBuilt = [];
let objectIS = null;     // first WHAT → IS
let deviationIS = null;  // second WHAT → IS

function mkBand(title, note){
  const tr = document.createElement('tr'); tr.className='band';
  const th = document.createElement('th'); th.colSpan = 5; th.innerHTML = `${title} <span>— ${note}</span>`;
  tr.appendChild(th); return tr;
}
function mkRow(def, i){
  const tr = document.createElement('tr'); tr.dataset.row = i;
  const th = document.createElement('th'); th.scope='row'; th.textContent = fillTokens(def.q);

  const tdIS = document.createElement('td');
  const tdNOT = document.createElement('td');
  const tdDIST = document.createElement('td');
  const tdCHG = document.createElement('td');

  const isTA  = document.createElement('textarea'); isTA.className='tableta';
  const notTA = document.createElement('textarea'); notTA.className='tableta';
  const distTA= document.createElement('textarea'); distTA.className='tableta';
  const chgTA = document.createElement('textarea'); chgTA.className='tableta';

  isTA.placeholder   = fillTokens(def.isPH || "");
  notTA.placeholder  = mkIsNotPH(fillTokens(def.notPH || ""), "");
  distTA.placeholder = mkDistPH("", "");
  chgTA.placeholder  = mkChangePH("");

  const refreshIsNotPH = ()=> notTA.placeholder = mkIsNotPH(fillTokens(def.notPH||""), isTA.value);
  const refreshDistPH  = ()=> distTA.placeholder = mkDistPH(isTA.value, notTA.value);
  const refreshChgPH   = ()=> chgTA.placeholder  = mkChangePH(distTA.value);

  [isTA,notTA,distTA].forEach(t=>t.addEventListener('input', ()=>{
    autoResize(t);
    if(t===isTA){ refreshIsNotPH(); refreshDistPH(); }
    if(t===notTA){ refreshDistPH(); }
    if(t===distTA){ refreshChgPH(); }
    saveToStorage();
  }));
  [isTA,notTA,distTA,chgTA].forEach(t=>{ autoResize(t); t.addEventListener('input', saveToStorage); });

  tdIS.appendChild(isTA); tdNOT.appendChild(notTA); tdDIST.appendChild(distTA); tdCHG.appendChild(chgTA);
  tr.append(th, tdIS, tdNOT, tdDIST, tdCHG);

  rowsBuilt.push({tr, th, def, isTA, notTA, distTA, chgTA});
  return tr;
}
function initTable(){
  let dataRowCount = 0;
  ROWS.forEach((def)=>{
    if(def.band){ tbody.appendChild(mkBand(def.band, def.note||'')); }
    else{
      const tr = mkRow(def, ++dataRowCount);
      tbody.appendChild(tr);
      if(dataRowCount===1) objectIS   = rowsBuilt[rowsBuilt.length-1].isTA;  // first data row IS
      if(dataRowCount===2) deviationIS= rowsBuilt[rowsBuilt.length-1].isTA;  // second data row IS
    }
  });

  [objectIS, deviationIS].forEach(el=>{
    el.addEventListener('input', ()=>{
      refreshAllTokenizedText();
      updateTitlesAndLabels();
      saveToStorage();
    });
  });
}
/* [script:table-build] end */

/* [script:preface-refs] start */
/* =================== Preface helpers & H1/H2 =================== */
const oneLine = document.getElementById('oneLine');
const proof = document.getElementById('proof');
const objectPrefill = document.getElementById('objectPrefill');
const healthy = document.getElementById('healthy');
const now = document.getElementById('now');

const labelHealthy = document.getElementById('labelHealthy');
const labelNow = document.getElementById('labelNow');

const docTitle = document.getElementById('docTitle');
const docSubtitle = document.getElementById('docSubtitle');

const impactNow = document.getElementById('impactNow');
const impactFuture = document.getElementById('impactFuture');
const impactTime = document.getElementById('impactTime');

[oneLine, proof, objectPrefill, healthy, now].forEach(el=>{
  el.addEventListener('input', ()=>{
    // If the table fields are empty, seed them from preface
    if(el===objectPrefill && objectIS && !objectIS.value.trim()){
      objectIS.value = el.value.trim(); autoResize(objectIS);
      refreshAllTokenizedText();
    }
    if(el===now && deviationIS && !deviationIS.value.trim()){
      deviationIS.value = el.value.trim(); autoResize(deviationIS);
      refreshAllTokenizedText();
    }
    if(el===oneLine && deviationIS && !deviationIS.value.trim()){
      deviationIS.value = el.value.trim(); autoResize(deviationIS);
      refreshAllTokenizedText();
    }
    updateTitlesAndLabels();
    saveToStorage();
  });
});
/* [script:preface-refs] end */

/* [script:tokens] start */
function firstSnippet(v){
  const s = (v||'').trim();
  if(!s) return '';
  return s.split(/\n|\. /)[0].slice(0,120);
}
function compactOneLine(str, max=90){
  const s = (str||'').trim().replace(/\s+/g,' ');
  return s.length>max ? s.slice(0,max-1)+'…' : s;
}
function getObjectFull(){
  return (objectPrefill.value || objectIS?.value || '').trim();
}
function getDeviationFull(){
  // Treat "What is happening now?" as the deviation for the problem statement.
  return (now.value || deviationIS?.value || '').trim();
}
function objectAnchor(){
  // Use a compact anchor for labels (not the full paragraph to keep labels readable)
  const src = getObjectFull() || 'the object';
  return compactOneLine(src, 80);
}
function fillTokens(text){
  const obj = firstSnippet(objectIS?.value)    || firstSnippet(getObjectFull()) || 'the object';
  const dev = firstSnippet(deviationIS?.value) || firstSnippet(getDeviationFull()) || 'the deviation';
  return (text||'').replace(/\{OBJECT\}/g, '“'+obj+'”').replace(/\{DEVIATION\}/g, '“'+dev+'”');
}
function refreshAllTokenizedText(){
  rowsBuilt.forEach(({th, def, isTA, notTA})=>{
    th.textContent = fillTokens(def.q);
    isTA.placeholder  = fillTokens(def.isPH||"");
    notTA.placeholder = mkIsNotPH(fillTokens(def.notPH||""), isTA.value);
  });
}
function updateTitlesAndLabels(){
  const objFull = getObjectFull();
  const devFull = getDeviationFull();
  const objAnch = objectAnchor();

  if(objFull && devFull){
    // H1/H2 use the FULL text as requested (concatenated)
    docTitle.textContent = `${objFull} — ${devFull}`;
    docSubtitle.textContent = `What is happening now to ${objAnch}: ${devFull}`;
    document.title = `${compactOneLine(objFull, 50)} — ${compactOneLine(devFull, 50)} · KT Intake`;
  }else{
    docTitle.textContent = "KT Intake — add Specific Object & What’s happening now to set the title";
    docSubtitle.textContent = "Describe Problem — awaiting Specific Object & What’s happening now…";
    document.title = "KT Intake";
  }

  // Dynamic labels for Healthy/Now
  labelNow.textContent = objAnch ? `What is happening now to ${objAnch}?` : "What is happening now?";
  labelHealthy.textContent = objAnch ? `What does healthy look like here for ${objAnch}?` : "What does healthy look like here?";

  // (Optional) adjust placeholders subtly to reflect anchor
  if(objAnch){
    now.placeholder = `e.g., For ${objAnch}: p95 1.8s, error 12–18%, retries 30/s, users see 500, etc.`;
    healthy.placeholder = `e.g., For ${objAnch}: p95 < 250ms, error < 0.5%, 300 rps sustained, etc.`;
  }
}
/* [script:tokens] end */

/* [script:init] start */
function autoResize(el){
  el.style.height = 'auto';
  const minH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ta-min-h'));
  el.style.height = Math.max(minH, el.scrollHeight, el.tagName==='TEXTAREA' ? 140 : 44) + 'px';
}
function init(){
  initTable();
  restoreFromStorage();
  refreshAllTokenizedText();
  updateTitlesAndLabels();
}
init();
/* [script:init] end */

/* [script:export] start */
/* =================== ASCII export =================== */
function wrapAt(str, width){
  if(!str) return '';
  const words = str.split(/\s+/); let line = '', out = [];
  words.forEach(w=>{
    if((line + ' ' + w).trim().length > width){ if(line) out.push(line); line = w; }
    else{ line = (line? line+' ' : '') + w; }
  });
  if(line) out.push(line);
  return out.join('\n');
}
function asciiBlock(title, body){
  let b = (body||'—').trim();
  return `> ${title}\n${b}\n\n`;
}
function toAscii(){
  /* Titles built from FULL object + FULL now */
  const title = document.getElementById('docTitle').textContent.trim();
  const subtitle = document.getElementById('docSubtitle').textContent.trim();

  /* Preface fields */
  const preface = [
    asciiBlock('One-sentence', oneLine.value),
    asciiBlock('Evidence / Proof', proof.value),
    asciiBlock('Specific Object', objectPrefill.value || (objectIS?.value||'')),
    asciiBlock('Healthy Baseline', healthy.value),
    asciiBlock('Current State (What is happening now?)', now.value),
  ].join('');

  /* Impact table */
  const impactHeaders = ["Current Impact","Future Impact","Timeframe"];
  const impactCells = [impactNow.value.trim()||"—", impactFuture.value.trim()||"—", impactTime.value.trim()||"—"];
  const impW = [0,0,0];
  impactHeaders.forEach((h,i)=>impW[i]=Math.max(impW[i], h.length));
  impactCells.forEach((c,i)=>c.split('\n').forEach(l=>impW[i]=Math.max(impW[i], l.length)));
  const pad=(s,w)=> s + ' '.repeat(w - s.length);
  const barImp='+'+impW.map(w=>'-'.repeat(w+2)).join('+')+'+';
  let impactOut = barImp+'\n';
  impactOut += '|' + impactHeaders.map((h,i)=>' '+pad(h,impW[i])+' ').join('|') + '|\n';
  impactOut += barImp+'\n';
  const maxLines = Math.max(...impactCells.map(c=>c.split('\n').length));
  for(let i=0;i<maxLines;i++){
    impactOut += '|' + [0,1,2].map(ci=>{
      const lines = impactCells[ci].split('\n');
      return ' '+pad(lines[i]||'', impW[ci])+' ';
    }).join('|') + '|\n';
  }
  impactOut += barImp+'\n\n';

  /* KT table */
  const headers = ["KT Question","IS","IS NOT","Distinctions","Changes"];
  const rows = [];
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.classList.contains('band')){
      rows.push({band: tr.textContent.trim()});
      return;
    }
    const q = tr.querySelector('th').textContent.trim();
    const t = tr.querySelectorAll('textarea');
    const is = t[0].value.trim(), no = t[1].value.trim(), di = t[2].value.trim(), ch = t[3].value.trim();
    const dLines = di.split('\n').map(s=>s.trim()).filter(Boolean);
    let cLines = ch.split('\n').map(s=>s.trim()).filter(Boolean);
    if(dLines.length && cLines.length < dLines.length){
      const missing = dLines.slice(cLines.length);
      cLines = cLines.concat(missing.map(s=>`[TODO] What changed re: ${s}?`));
    }
    rows.push({
      q: wrapAt(q, 26),
      is: is || "—",
      no: no || "—",
      di: dLines.length ? dLines.join('\n') : "—",
      ch: cLines.length ? cLines.join('\n') : (dLines.length ? "[TODO] Map changes to each distinction above" : "—"),
    });
  });

  const colW = [0,0,0,0,0];
  const widen=(i,s)=>s.split('\n').forEach(l=>colW[i]=Math.max(colW[i], l.length));
  headers.forEach((h,i)=>widen(i,h));
  rows.forEach(r=>{ if(r.band) return; widen(0,r.q); widen(1,r.is); widen(2,r.no); widen(3,r.di); widen(4,r.ch); });
  const bar='+'+colW.map(w=>'-'.repeat(w+2)).join('+')+'+';

  let ktOut = bar+'\n';
  ktOut += '|' + headers.map((h,i)=>' '+pad(h,colW[i])+' ').join('|') + '|\n';
  ktOut += bar+'\n';
  rows.forEach(r=>{
    if(r.band){ ktOut += bar+'\n' + `== ${r.band} ==\n` + bar+'\n'; return; }
    const cells=[r.q.split('\n'), r.is.split('\n'), r.no.split('\n'), r.di.split('\n'), r.ch.split('\n')];
    const max=Math.max(...cells.map(c=>c.length));
    for(let i=0;i<max;i++){
      ktOut+='|' + [0,1,2,3,4].map(ci=>' '+pad(cells[ci][i]||'', colW[ci])+' ').join('|') + '|\n';
    }
    ktOut+=bar+'\n';
  });

  /* Combine */
  let out = '';
  out += title + '\n';
  out += subtitle + '\n\n';
  out += preface;
  out += 'IMPACT\n' + impactOut;
  out += 'KT IS / IS NOT — Details\n' + ktOut;
  return out;
}
async function copyAscii(){
  const ascii = toAscii();
  try{
    await navigator.clipboard.writeText(ascii);
    showToast('Copied as ASCII. Paste into your ticket ✨');
  }catch(e){
    const w = window.open('', '_blank', 'width=900,height=650');
    w.document.write('<pre style="white-space:pre-wrap;font:13px/1.5 monospace;margin:0;padding:16px;">'+
      ascii.replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[s])) +'</pre>');
    w.document.title = 'KT — ASCII Export';
  }
}
document.getElementById('copyBtn').addEventListener('click', copyAscii);
/* [script:export] end */

/* [script:storage] start */
/* =================== Autosave =================== */
const STORAGE_KEY='kt-intake-full-v2';
function saveToStorage(){
  const data={ pre:{ oneLine:oneLine.value, proof:proof.value, objectPrefill:objectPrefill.value, healthy:healthy.value, now:now.value },
               impact:{ now:impactNow.value, future:impactFuture.value, time:impactTime.value },
               table:[] };
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.classList.contains('band')){ data.table.push({band: tr.textContent.trim()}); return; }
    const t=tr.querySelectorAll('textarea');
    data.table.push({q: tr.querySelector('th').textContent.trim(), is:t[0].value, no:t[1].value, di:t[2].value, ch:t[3].value});
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function restoreFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
  const data = JSON.parse(raw);
  if(data.pre){
    oneLine.value=data.pre.oneLine||''; proof.value=data.pre.proof||'';
    objectPrefill.value=data.pre.objectPrefill||''; healthy.value=data.pre.healthy||'';
    now.value=data.pre.now||'';
    [oneLine,proof,objectPrefill,healthy,now].forEach(autoResize);
    if(objectPrefill.value && objectIS && !objectIS.value) { objectIS.value=objectPrefill.value; autoResize(objectIS); }
    if(now.value && deviationIS && !deviationIS.value) { deviationIS.value=now.value; autoResize(deviationIS); }
  }
  if(data.impact){
    impactNow.value=data.impact.now||''; impactFuture.value=data.impact.future||''; impactTime.value=data.impact.time||'';
    [impactNow,impactFuture,impactTime].forEach(autoResize);
  }
  if(Array.isArray(data.table)){
    let i=0;
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      if(tr.classList.contains('band')) return;
      const rec = data.table.find(d=>d.q===tr.querySelector('th').textContent.trim() && !d.band) || data.table[i++];
      if(!rec) return;
      const t = tr.querySelectorAll('textarea');
      t[0].value=rec.is||''; t[1].value=rec.no||''; t[2].value=rec.di||''; t[3].value=rec.ch||'';
      t.forEach(autoResize);
    });
  }
}
/* [script:storage] end */

/* [script:toast] start */
function showToast(msg){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show';
  setTimeout(()=>toast.classList.remove('show'), 2200);
}
/* [script:toast] end */
</script>
<!-- [script] end -->
</body>
</html>
