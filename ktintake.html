<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KT Intake</title>

<!--
[contract] start
EDITING CONTRACT for ChatGPT & humans:
- Keep these anchors intact. Prefer unified diffs (*** Begin Patch / *** End Patch) that edit INSIDE the relevant anchors only.
- Do not remove tokens: {OBJECT} / {DEVIATION}.
- Keep function names/signatures for copy to ASCII intact.
- Avoid structural rewrites unless requested; keep single-file layout.
Anchors present:
  [styles] [vars] [header] [section:preface] [subtitle]
  [section:impact] [section:table]
  [script] [rows] [script:table-build] [script:preface-refs]
  [script:tokens] [script:init] [script:export] [script:storage] [script:toast]
[contract] end
-->

<!-- [styles] start -->
<style>
  /* [vars] start */
  :root{
    /* Apple-like daytime palette */
    --bg:#f5f7fb;
    --panel:#ffffff;
    --ink:#0c1220;
    --muted:#5b6475;
    --line:#e6eaf2;
    --band:#f6f8fc;
    --accent:#007aff;

    /* Layout */
    --qcol-w:10.5rem;     /* narrow KT Question column */
    --ta-fs:15px;         /* textarea font size */
    --ta-min-h:380px;     /* taller by default */
    --radius:14px;
    --shadow:0 8px 24px rgba(12,18,32,.08), 0 1px 0 rgba(255,255,255,.6) inset;
    --speed:.22s;
  }
  /* [vars] end */

  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"SF Pro Text","SF Pro Display",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    font-size:15px; line-height:1.6; letter-spacing:-0.01em;
  }
  header{
    max-width:1240px; margin:22px auto 8px; padding:0 12px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  h1#docTitle{font-size:22px; font-weight:800; margin:0; letter-spacing:-0.01em; white-space:pre-wrap;}
  .subtle{color:var(--muted); font-size:12px;}
  .btn{
    appearance:none; border:1px solid var(--line); background:var(--accent); color:#fff;
    padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    transition:transform var(--speed), box-shadow var(--speed), border-color var(--speed);
    box-shadow:0 6px 18px rgba(0,122,255,.18);
  }
  .btn:hover{transform:translateY(-1px);}

  .wrap{max-width:1240px; margin:0 auto 40px; padding:0 12px;}
  h2#docSubtitle{margin:12px 0 8px; font-size:16px; font-weight:700; color:#2a3957; white-space:pre-wrap;}

  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:20px 22px 24px; margin:0 0 32px;
  }
  .card h3{
    margin:0 0 16px;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,ui-sans-serif;
    font-size:15px; font-weight:700; letter-spacing:.32px; text-transform:uppercase; color:#1d2845;
  }
  .preface-stack{display:flex; flex-direction:column;}
  .grid{ display:grid; gap:12px; }
  .grid.cols-2{ grid-template-columns:1fr 1fr; }
  .grid.cols-3{ grid-template-columns:1fr 1fr 1fr; }
  .containment-grid .contain-status{ grid-column:span 2; }
  .containment-radios{ display:flex; flex-wrap:wrap; gap:12px; }
  .radio-option{ display:flex; align-items:center; gap:6px; }
  .comm-grid{ grid-template-columns:1fr 1fr auto; align-items:end; }
  .comm-grid .field{ margin:0; }
  .comm-grid .field label{ margin-bottom:4px; }
  .comm-grid.comm-grid--single{ grid-template-columns:1fr; }
  .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .chipset{ display:flex; gap:8px; flex-wrap:wrap; }
  .chipset .chip{ position:relative; display:flex; align-items:center; gap:6px; }
  .chipset .chip label{ display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border-radius:999px; border:1px solid #dfe5f2; background:#f7f9ff; font-weight:600; font-size:13px; color:#1d2845; cursor:pointer; transition:border-color var(--speed), box-shadow var(--speed), background var(--speed); }
  .chipset .chip input[type="checkbox"]{ position:absolute; top:0; left:0; opacity:0; pointer-events:none; width:1px; height:1px; }
  .chipset .chip input[type="checkbox"]:focus + label{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,122,255,.18); }
  .chipset .chip input[type="checkbox"]:checked + label{ border-color:var(--accent); background:rgba(0,122,255,.1); color:var(--accent); }
  .chip-label{ font-weight:700; color:#1d2845; min-width:150px; flex:0 0 auto; }
  .caption{ margin:-6px 0 16px; font-size:12px; color:var(--muted); }
  .gap-24{ gap:24px; }
  .field label{display:block; font-weight:700; margin-bottom:6px;}
  .field small{display:block; color:var(--muted); margin-top:4px;}
  fieldset.field{border:0; padding:0; margin:0;}
  fieldset.field legend{font-weight:700; margin-bottom:6px; font-size:14px; color:#1d2845;}
  .field textarea, .field input[type="text"]{
    width:100%; box-sizing:border-box;
    font:15px/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:12px 14px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  .field textarea{min-height:140px; resize:vertical;}
  .field input[type="text"]{height:44px;}
  .field input[readonly]{background:#f4f6fb; color:#3b4962;}
  .field input[type="time"], .field select{
    width:100%; box-sizing:border-box; height:44px;
    font:15px/1.55 "SF Pro Text","SF Pro Display",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:8px 12px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  .field input[type="time"]:focus, .field select:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#fff;}
  .btn-mini{
    appearance:none; border:1px solid #dfe5f2; background:#eef3ff; color:var(--accent);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px;
    transition:transform var(--speed), box-shadow var(--speed), border-color var(--speed);
    box-shadow:0 4px 12px rgba(0,122,255,.12);
  }
  .btn-mini:hover{transform:translateY(-1px);}
  .btn-mini:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18);}
  .field textarea::placeholder, .field input::placeholder{color:#8b93a4;}
  .field textarea:focus, .field input:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#fff;}

  /* Impact strip */
  .impact{ padding:18px; }
  .impact > h3{
    margin:0 0 18px;
    font-size:17px;
    font-weight:700;
    letter-spacing:-0.02em;
    color:#1f2b40;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  .impact .field{padding:4px 0;}
  .impact .field h3{
    margin:0 0 6px;
    font-size:15px;
    font-weight:600;
    letter-spacing:-0.015em;
    color:#22324b;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  .impact .field label{
    font-size:13px;
    font-weight:600;
    letter-spacing:-0.01em;
    color:#3b4962;
    margin-bottom:8px;
  }
  .impact .field small{
    font-size:12px;
    line-height:1.55;
    letter-spacing:0;
  }
  .impact textarea{
    font-family:"SF Pro Text","SF Pro Display",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    font-size:14px;
    line-height:1.6;
    letter-spacing:-0.01em;
  }

  /* Table */
  table{
    table-layout:fixed;
    
    width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:var(--radius);
    background:var(--panel); border:1px solid var(--line); box-shadow:var(--shadow);
  }
  thead th{
    word-wrap:break-word;
    white-space:normal;
    
    position:sticky; top:0; z-index:3;
    background:linear-gradient(180deg, #ffffff, #fafbfe);
    color:#0c1220; text-align:left; font-size:12px; letter-spacing:.4px;
    padding:12px; border-bottom:1px solid var(--line);
  }
  tbody td, tbody th{
    border-bottom:1px solid var(--line); vertical-align:top; padding:10px 8px; transition:background-color var(--speed);
  }
  tbody tr:last-child td, tbody tr:last-child th{border-bottom:0;}
  tbody tr:hover td, tbody tr:hover th{background-color:#fafbfe;}
  tbody th{
    width:var(--qcol-w); max-width:var(--qcol-w); min-width:var(--qcol-w);
    white-space:normal; word-break:break-word; font-weight:700; color:#0c1220;
  }
  .band th{
    padding:12px; font-weight:800; color:#2a3957;
    background:linear-gradient(180deg, var(--band), #ffffff);
    border-top:1px solid var(--line); border-bottom:1px solid var(--line);
  }
  .band th span{opacity:.85; font-weight:600; color:#6b768a}
  textarea.tableta{
    width:100%; min-height:var(--ta-min-h); resize:vertical; box-sizing:border-box;
    font:var(--ta-fs)/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:12px 14px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  textarea.tableta::placeholder{color:#8b93a4;}
  textarea.tableta:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#ffffff;}

  /* Toast */
  .toast{
    position:fixed; right:18px; bottom:18px; background:#0f1a10; color:#dff5e1; border:1px solid #164f19;
    padding:10px 12px; border-radius:12px; opacity:0; transform:translateY(10px); transition:.25s; pointer-events:none; box-shadow:var(--shadow);
  }
  .toast.show{opacity:1; transform:translateY(0);}
</style>
<!-- [styles] end -->
</head>
<body>
  <!-- [header] start -->
  <header>
    <h1 id="docTitle">KT Intake</h1>
    <button class="btn" id="genSummaryBtn" onclick="onGenerateSummary()">Generate Summary</button>
  </header>
  <!-- [header] end -->

  <div class="wrap">
    <!-- [section:preface] start -->
    <section class="preface-stack">
      <div class="card">
        <h3>Bridge Activation</h3>
        <p class="caption">Capture only what’s needed to activate the bridge and set comms cadence.</p>
        <div class="grid cols-3">
          <div class="field">
            <label for="bridgeOpenedUtc">Bridge opened (UTC)</label>
            <div class="inline">
              <input type="text" id="bridgeOpenedUtc" readonly aria-readonly="true" />
              <button type="button" class="btn-mini" id="bridgeSetNowBtn" aria-label="Stamp bridge opened time">Set Now</button>
            </div>
          </div>
          <div class="field">
            <label for="icName">Incident Commander</label>
            <input type="text" id="icName" placeholder="" />
          </div>
          <div class="field">
            <label for="bcName">Bridge Coordinator</label>
            <input type="text" id="bcName" placeholder="" />
          </div>
        </div>
        <div class="grid cols-3">
          <div class="field">
            <label for="semOpsName">SEM/Ops Lead</label>
            <input type="text" id="semOpsName" placeholder="" />
          </div>
          <div class="field">
            <label for="severity">Severity</label>
            <select id="severity">
              <option value="">Select severity</option>
              <option value="S1">S1</option>
              <option value="S2">S2</option>
              <option value="S3">S3</option>
            </select>
          </div>
          <div class="field">
            <label for="nextUpdateDue">Next update due</label>
            <input type="time" id="nextUpdateDue" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Problem Summary</h3>
        <div class="grid">
          <div class="field">
            <label for="oneLine">In one sentence, what is broken for you right now?</label>
            <textarea id="oneLine" placeholder=""></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Evidence &amp; Object</h3>
        <div class="inline">
          <span class="chip-label">Detection Source</span>
          <div class="chipset" role="group" aria-label="Detection Source">
            <div class="chip">
              <input type="checkbox" id="detectMonitoring" />
              <label for="detectMonitoring">Monitoring</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="detectUserReport" />
              <label for="detectUserReport">User Report</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="detectAutomation" />
              <label for="detectAutomation">Automation</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="detectOther" />
              <label for="detectOther">Other</label>
            </div>
          </div>
        </div>
        <div class="inline">
          <span class="chip-label">Evidence Collected</span>
          <div class="chipset" role="group" aria-label="Evidence Collected">
            <div class="chip">
              <input type="checkbox" id="evScreenshot" />
              <label for="evScreenshot">Screenshot</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="evLogs" />
              <label for="evLogs">Logs</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="evMetrics" />
              <label for="evMetrics">Metrics</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="evRepro" />
              <label for="evRepro">Repro</label>
            </div>
            <div class="chip">
              <input type="checkbox" id="evOther" />
              <label for="evOther">Other</label>
            </div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="field">
            <label for="proof">What proves a deviation exists?</label>
            <small>Examples: alerts, error messages, metric spikes/drops, log lines, screenshots, reproducible steps.</small>
            <textarea id="proof" placeholder=""></textarea>
          </div>
          <div class="field">
            <label for="objectPrefill">What is the specific object being affected?</label>
            <small>Hardware name and model, Function/Module/Method, Container/Service/API, datastore/volume/bucket/table, network element, identity/policy/role, pipeline/job.</small>
            <textarea id="objectPrefill" placeholder=""></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Baseline vs Current</h3>
        <div class="grid cols-2">
          <div class="field">
            <label id="labelHealthy" for="healthy">What does healthy look like here?</label>
            <small>What was the expected behavior?</small>
            <textarea id="healthy" placeholder=""></textarea>
          </div>
          <div class="field">
            <label id="labelNow" for="now">What is happening now?</label>
            <small>What has been verified and measured vs same baseline (same metrics as above)? What symptom is being presented?</small>
            <textarea id="now" placeholder=""></textarea>
          </div>
        </div>
      </div>
    </section>
    <!-- [section:preface] end -->

    <!-- [subtitle] start -->
    <h2 id="docSubtitle">Describe The Problem</h2>
    <!-- [subtitle] end -->

    <!-- [section:impact] start -->
    <div class="card impact">
      <h3>Impact</h3>
      <div class="grid cols-3 containment-grid">
        <fieldset class="field contain-status">
          <legend>Containment Status</legend>
          <div class="containment-radios" role="radiogroup" aria-label="Containment Status">
            <div class="radio-option">
              <input type="radio" id="containNone" name="containStatus" value="none" />
              <label for="containNone">No action yet</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="containMitigation" name="containStatus" value="mitigation" />
              <label for="containMitigation">Temporary mitigation applied</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="containRestore" name="containStatus" value="restore" />
              <label for="containRestore">Full restoration in progress</label>
            </div>
          </div>
        </fieldset>
        <div class="field">
          <label for="containDesc">Containment Description</label>
          <input type="text" id="containDesc" placeholder="What immediate step reduces risk?" />
        </div>
      </div>
      <div class="grid cols-3 gap-24">
        <div class="field">
          <h3>Current Impact</h3>
          <label for="impactNow">Current Impact</label>
          <small>Who/what is affected now? Quantify: users/tenants/regions, transactions failing, SLI/SLO deltas (avail %, p95/p99, error %), data at risk (loss/corruption/exposure), workarounds.</small>
          <textarea id="impactNow" placeholder=""></textarea>
        </div>
        <div class="field">
          <h3>Future Impact</h3>
          <label for="impactFuture">Future Impact</label>
          <small>If unresolved what happens? Blast radius growth, SLO/SLA breach, revenue/penalties, compliance, backlog/consumer lag, churn, on-call fatigue.</small>
          <textarea id="impactFuture" placeholder=""></textarea>
        </div>
        <div class="field">
          <h3>Timeframe</h3>
          <label for="impactTime">Timeframe</label>
          <small>When will the Future Impact become Current Impact? (Best Estimate). What deadlines/SLAs do we need to be aware of?</small>
          <textarea id="impactTime" placeholder=""></textarea>
        </div>
      </div>
    </div>
    <!-- [section:impact] end -->

    <div class="card">
      <h3>Communication Snapshot</h3>
      <div class="grid comm-grid">
        <div class="field">
          <label for="commInternalSent">Internal update sent?</label>
          <input type="checkbox" id="commInternalSent" />
        </div>
        <div class="field">
          <label for="commInternalTs">Timestamp (UTC)</label>
          <input type="text" id="commInternalTs" readonly aria-readonly="true" />
        </div>
        <div class="field">
          <span class="subtle" aria-hidden="true">&nbsp;</span>
          <button type="button" class="btn-mini" id="commInternalStampBtn" aria-label="Stamp Internal Update Time">Stamp Now</button>
        </div>
      </div>
      <div class="grid comm-grid">
        <div class="field">
          <label for="commExternalSent">External customer update sent?</label>
          <input type="checkbox" id="commExternalSent" />
        </div>
        <div class="field">
          <label for="commExternalTs">Timestamp (UTC)</label>
          <input type="text" id="commExternalTs" readonly aria-readonly="true" />
        </div>
        <div class="field">
          <span class="subtle" aria-hidden="true">&nbsp;</span>
          <button type="button" class="btn-mini" id="commExternalStampBtn" aria-label="Stamp External Update Time">Stamp Now</button>
        </div>
      </div>
      <div class="grid comm-grid comm-grid--single">
        <div class="field">
          <label for="commNextUpdateTime">Next update scheduled for</label>
          <input type="time" id="commNextUpdateTime" />
        </div>
      </div>
    </div>

    <!-- [section:table] start -->
    <p class="subtle">Problem Analysis</p>

    <table id="ktTable" aria-label="KT IS / IS NOT intake table">
<colgroup>
  <col style="width:18%;">
  <col style="width:21%;">
  <col style="width:21%;">
  <col style="width:20%;">
  <col style="width:20%;">
</colgroup>

      <thead>
        <tr>
          <th scope="col">KT Question</th>
          <th scope="col">IS <span class="subtle">— facts only</span></th>
          <th scope="col">IS NOT <span class="subtle">— similar &amp; reasonable and could be but is not occuring</span></th>
          <th scope="col">Distinctions <span class="subtle">— Unique characteristics about the IS</span></th>
          <th scope="col">Changes <span class="subtle">— Changes that happened in on around or about each Distinction</span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <!-- [section:table] end -->


    <!-- [section:summary] start -->
    <div class="card" id="summaryCard" style="display:none;">
      <h3>Copy &amp; Paste Summary</h3>
      <pre id="summaryPre" style="white-space:pre-wrap;font:13px/1.6 monospace;margin:0;"></pre>
    </div>
    <!-- [section:summary] end -->

  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- [script] start -->
<script>
/* [rows] start */
/* =================== Core data & prompts (KT Problem Analysis) =================== */
/* Use {OBJECT} / {DEVIATION} tokens anywhere you want auto-fill. */
const ROWS = [
  { band: "WHAT", note: "Define the problem precisely (Object & Deviation)." },

  {
    q: "WHAT — Specific Object/Thing is having the {DEVIATION}",
    isPH:
      "What specific object has {DEVIATION}?",
    notPH:
      "What similar objects could reasonably have, but do NOT have {DEVIATION}?"
  },
  {
    q: "WHAT — Specific Deviation does the {OBJECT} have?",
    isPH:
      "What exactly is the deviation that has been confirmed?",
    notPH:
      "What reasonable symptoms could the {OBJECT} have had, but we have verified are NOT present?"
  },

  { band: "WHERE", note: "Locate the problem (geography/topology and on the object)." },

  {
    q: "WHERE — is the {OBJECT} geographically/topology when the {DEVIATION} occurs?",
    isPH:
      "Where is {OBJECT} when {DEVIATION} occurs?",
    notPH:
      "Where would you reasonably expect the {OBJECT} could have been when the {DEVIATION} was observed but we do NOT see it?"
  },
  {
    q: "WHERE — On the {OBJECT} is the {DEVIATION} observed?",
    isPH:
      "Where on {OBJECT} is {DEVIATION} observed?",
    notPH:
      "What neighboring parts on the {OBJECT} do NOT show {DEVIATION}?"
  },

  { band: "WHEN", note: "Timing and Description" },

  {
    q: "WHEN — Was the {DEVIATION} First observed for {OBJECT}",
    isPH:
      "When was {DEVIATION} first observed for {OBJECT}? (date/time/zone)",
    notPH:
      "When was the last known good for {OBJECT}? When reasonably could we have observed other {DEVIATION} on {OBJECT} but we did not?"
  },
  {
    q: "WHEN — Since was the first time has {DEVIATION} been logged? What Pattern?",
    isPH:
      "Since first occurrence, when does {DEVIATION} re-occur?\n• What Pattern (continuous/periodic/sporadic/one time)",
    notPH:
      "What Similar windows/patterns of times is the {OBJECT} not having {DEVIATION}?"
  },
  {
    q: "WHEN — Describe using words When the {DEVIATION} was first seen",
    isPH:
      "At what point in {OBJECT}’s life-cycle did {DEVIATION} appear?\n• Use words like before, during, or after to describe these times and consider multiple lifecycles",
    notPH:
      "What Adjacent life-cycle moments could we have reasonably caught or observed the {DEVIATION} but we did not?"
  },

  { band: "EXTENT", note: "How big is it? Magnitude, count, scope, trend." },

  {
    q: "EXTENT — What is the population or size of {OBJECT} affected?",
    isPH:
      "How many {OBJECT}s have {DEVIATION}?\nTrend (↑/↓/stable)?",
    notPH:
      "What population or Comparable object sets have not been affected"
  },
  {
    q: "EXTENT — What is the size of a single {DEVIATION}?",
    isPH:
      "How big is a single {DEVIATION} on {OBJECT}?\nTrend (↑/↓/stable)?",
    notPH:
      "What sizes could the {DEVIATION} reasonably have been but were not?"
  },
  {
    q: "EXTENT — How many {DEVIATION} are occuring on each {OBJECT}?",
    isPH:
      "How many instances of {DEVIATION} per {OBJECT}?\nTrend (↑/↓/stable)?",
    notPH:
      "Reasonably, how many instances of {DEVIATION} could have occured per {OBJECT} but did not?"
  },
];

/* [rows] end */

/* [script:table-build] start */
/* =================== Build table & dynamic tokens =================== */
const tbody = document.getElementById('tbody');
const rowsBuilt = [];
let objectIS = null;     // first WHAT → IS
let deviationIS = null;  // second WHAT → IS
let objectISDirty = false;
let deviationISDirty = false;

function mkBand(title, note){
  const tr = document.createElement('tr'); tr.className='band';
  const th = document.createElement('th'); th.colSpan = 5; th.innerHTML = `${title} <span>— ${note}</span>`;
  tr.appendChild(th); return tr;
}
function mkRow(def, i){
  const tr = document.createElement('tr'); tr.dataset.row = i;
  const th = document.createElement('th'); th.scope='row'; th.textContent = fillTokens(def.q);

  const tdIS = document.createElement('td');
  const tdNOT = document.createElement('td');
  const tdDIST = document.createElement('td');
  const tdCHG = document.createElement('td');

  const isTA  = document.createElement('textarea'); isTA.className='tableta';
  const notTA = document.createElement('textarea'); notTA.className='tableta';
  const distTA= document.createElement('textarea'); distTA.className='tableta';
  const chgTA = document.createElement('textarea'); chgTA.className='tableta';

  isTA.placeholder   = fillTokens(def.isPH || "");
  notTA.placeholder  = mkIsNotPH(fillTokens(def.notPH || ""), "");
  distTA.placeholder = mkDistPH("", "");
  chgTA.placeholder  = mkChangePH("");

  const refreshIsNotPH = ()=> notTA.placeholder = mkIsNotPH(fillTokens(def.notPH||""), isTA.value);
  const refreshDistPH  = ()=> distTA.placeholder = mkDistPH(isTA.value, notTA.value);
  const refreshChgPH   = ()=> chgTA.placeholder  = mkChangePH(distTA.value);

  [isTA,notTA,distTA].forEach(t=>t.addEventListener('input', ()=>{
    autoResize(t);
    if(t===isTA){ refreshIsNotPH(); refreshDistPH(); }
    if(t===notTA){ refreshDistPH(); }
    if(t===distTA){ refreshChgPH(); }
    saveToStorage();
  }));
  [isTA,notTA,distTA,chgTA].forEach(t=>{ autoResize(t); t.addEventListener('input', saveToStorage); });

  tdIS.appendChild(isTA); tdNOT.appendChild(notTA); tdDIST.appendChild(distTA); tdCHG.appendChild(chgTA);
  tr.append(th, tdIS, tdNOT, tdDIST, tdCHG);

  rowsBuilt.push({tr, th, def, isTA, notTA, distTA, chgTA});
  return tr;
}
function initTable(){
  let dataRowCount = 0;
  ROWS.forEach((def)=>{
    if(def.band){ tbody.appendChild(mkBand(def.band, def.note||'')); }
    else{
      const tr = mkRow(def, ++dataRowCount);
      tbody.appendChild(tr);
      if(dataRowCount===1) objectIS   = rowsBuilt[rowsBuilt.length-1].isTA;  // first data row IS
      if(dataRowCount===2) deviationIS= rowsBuilt[rowsBuilt.length-1].isTA;  // second data row IS
    }
  });

  [objectIS, deviationIS].forEach(el=>{
    el.addEventListener('input', ()=>{
      if(el===objectIS) objectISDirty = true;
      if(el===deviationIS) deviationISDirty = true;
      refreshAllTokenizedText();
      updateTitlesAndLabels();
      saveToStorage();
    });
  });
}
/* [script:table-build] end */

/* [script:preface-refs] start */
/* =================== Preface helpers & H1/H2 =================== */
const oneLine = document.getElementById('oneLine');
const proof = document.getElementById('proof');
const objectPrefill = document.getElementById('objectPrefill');
const healthy = document.getElementById('healthy');
const now = document.getElementById('now');

const bridgeOpenedUtc = document.getElementById('bridgeOpenedUtc');
const bridgeSetNowBtn = document.getElementById('bridgeSetNowBtn');
const icName = document.getElementById('icName');
const bcName = document.getElementById('bcName');
const semOpsName = document.getElementById('semOpsName');
const severity = document.getElementById('severity');
const nextUpdateDue = document.getElementById('nextUpdateDue');

const detectMonitoring = document.getElementById('detectMonitoring');
const detectUserReport = document.getElementById('detectUserReport');
const detectAutomation = document.getElementById('detectAutomation');
const detectOther = document.getElementById('detectOther');

const evScreenshot = document.getElementById('evScreenshot');
const evLogs = document.getElementById('evLogs');
const evMetrics = document.getElementById('evMetrics');
const evRepro = document.getElementById('evRepro');
const evOther = document.getElementById('evOther');

const labelHealthy = document.getElementById('labelHealthy');
const labelNow = document.getElementById('labelNow');

const docTitle = document.getElementById('docTitle');
const docSubtitle = document.getElementById('docSubtitle');

const impactNow = document.getElementById('impactNow');
const impactFuture = document.getElementById('impactFuture');
const impactTime = document.getElementById('impactTime');

const containNone = document.getElementById('containNone');
const containMitigation = document.getElementById('containMitigation');
const containRestore = document.getElementById('containRestore');
const containDesc = document.getElementById('containDesc');

const commInternalSent = document.getElementById('commInternalSent');
const commInternalTs = document.getElementById('commInternalTs');
const commInternalStampBtn = document.getElementById('commInternalStampBtn');
const commExternalSent = document.getElementById('commExternalSent');
const commExternalTs = document.getElementById('commExternalTs');
const commExternalStampBtn = document.getElementById('commExternalStampBtn');
const commNextUpdateTime = document.getElementById('commNextUpdateTime');

[oneLine, proof, objectPrefill, healthy, now].forEach(el=>{
  el.addEventListener('input', ()=>{
    // If the table fields are empty, seed them from preface
    if(el===objectPrefill && objectIS && !objectIS.value.trim()){
      objectIS.value = el.value.trim(); autoResize(objectIS);
      refreshAllTokenizedText();
    }
    if(el===now && deviationIS && !deviationIS.value.trim()){
      deviationIS.value = el.value.trim(); autoResize(deviationIS);
      refreshAllTokenizedText();
    }
    if(el===oneLine && deviationIS && !deviationIS.value.trim()){
      deviationIS.value = el.value.trim(); autoResize(deviationIS);
      refreshAllTokenizedText();
    }
    updateTitlesAndLabels();
    saveToStorage();
  });
  el.addEventListener('keyup', syncMirror);
  el.addEventListener('change', ()=>syncMirror(true));
});

[icName, bcName, semOpsName].forEach(el=>{
  if(el){ el.addEventListener('input', saveToStorage); }
});
[severity, nextUpdateDue, commNextUpdateTime].forEach(el=>{
  if(el){ el.addEventListener('change', saveToStorage); }
});

[
  detectMonitoring,
  detectUserReport,
  detectAutomation,
  detectOther,
  evScreenshot,
  evLogs,
  evMetrics,
  evRepro,
  evOther,
  commInternalSent,
  commExternalSent,
  containNone,
  containMitigation,
  containRestore
].forEach(el=>{ if(el){ el.addEventListener('change', saveToStorage); } });

if(containDesc){ containDesc.addEventListener('input', saveToStorage); }

if(bridgeSetNowBtn){
  bridgeSetNowBtn.addEventListener('click', ()=>{
    bridgeOpenedUtc.value = new Date().toISOString();
    saveToStorage();
    bridgeOpenedUtc.focus();
  });
}

if(commInternalStampBtn){
  commInternalStampBtn.addEventListener('click', ()=>{
    commInternalTs.value = new Date().toISOString();
    if(commInternalSent && !commInternalSent.checked){ commInternalSent.checked = true; }
    saveToStorage();
    commInternalTs.focus();
  });
}

if(commExternalStampBtn){
  commExternalStampBtn.addEventListener('click', ()=>{
    commExternalTs.value = new Date().toISOString();
    if(commExternalSent && !commExternalSent.checked){ commExternalSent.checked = true; }
    saveToStorage();
    commExternalTs.focus();
  });
}
/* [script:preface-refs] end */

/* [script:tokens] start */
function firstSnippet(v){
  const s = (v||'').trim();
  if(!s) return '';
  // Return the first line or sentence, up to 120 chars (not just one char)
  const first = s.split(/\n|\. /)[0];
  return first.length > 120 ? first.slice(0,120) : first;
}
function compactOneLine(str, max=90){
  const s = (str||'').trim().replace(/\s+/g,' ');
  return s.length>max ? s.slice(0,max-1)+'…' : s;
}
function getObjectFull(){
  return (objectPrefill.value || objectIS?.value || '').trim();
}
function getDeviationFull(){
  // Treat "What is happening now?" as the deviation for the problem statement.
  return (now.value || deviationIS?.value || '').trim();
}
function objectAnchor(){
  // Use a compact anchor for labels (not the full paragraph to keep labels readable)
  const src = getObjectFull() || 'the object';
  return compactOneLine(src, 80);
}
function fillTokens(text){
  const obj = firstSnippet(objectIS?.value)    || firstSnippet(getObjectFull()) || 'the object';
  const dev = firstSnippet(deviationIS?.value) || firstSnippet(getDeviationFull()) || 'the deviation';
  return (text||'').replace(/\{OBJECT\}/g, '“'+obj+'”').replace(/\{DEVIATION\}/g, '“'+dev+'”');
}
function mkIsNotPH(baseCopy, isVal){
  const base = (baseCopy||'').trim();
  const isSnippet = firstSnippet(isVal);
  if(isSnippet){
    const prompt = fillTokens(``);
    return base ? `${prompt}\n\n${base}` : prompt;
  }
  return base || fillTokens('');
}
function mkDistPH(isVal, notVal){
  const base = fillTokens('');
  const isSnippet = firstSnippet(isVal);
  const notSnippet = firstSnippet(notVal);
  const parts = [];
  if(isSnippet){ parts.push(`What is different, odd, special, or uniquely true about “${isSnippet}”?`); }
  if(notSnippet){ parts.push(`Only list traits that are not shared by “${notSnippet}”`); }
  const lead = parts.length ? parts.join(' ') + '' : '';
  return lead ? `${lead}\n${base}` : base;
}
function mkChangePH(distText){
  const base = fillTokens('');
  const distSnippet = firstSnippet(distText);
  if(distSnippet){
    return `What changed in, on, around, or about “${distSnippet}”, Ask this question for each distinction listed.\n${base}`;
  }
  return base;
}
function refreshAllTokenizedText(){
  rowsBuilt.forEach(({th, def, isTA, notTA})=>{
    th.textContent = fillTokens(def.q);
    isTA.placeholder  = fillTokens(def.isPH||"");
    notTA.placeholder = mkIsNotPH(fillTokens(def.notPH||""), isTA.value);
  });
}
function updateTitlesAndLabels(){
  const objFull = getObjectFull();
  const devFull = getDeviationFull();
  const objAnch = objectAnchor();

  if(objFull && devFull){
    // H1/H2 use the FULL text as requested (concatenated)
    docTitle.textContent = `${objFull} — ${devFull}`;
    docSubtitle.textContent = `What is happening now to ${objAnch}: ${devFull}`;
    document.title = `${compactOneLine(objFull, 50)} — ${compactOneLine(devFull, 50)} · KT Intake`;
  }else{
    docTitle.textContent = "KT Intake";
    docSubtitle.textContent = "Describe Problem";
    document.title = "KT Intake";
  }

  // Dynamic labels for Healthy/Now
  labelNow.textContent = objAnch ? `What is happening now to ${objAnch}?` : "What is happening now?";
  labelHealthy.textContent = objAnch ? `What does healthy look like here for ${objAnch}?` : "What does healthy look like?";

  // (Optional) adjust placeholders subtly to reflect anchor
  if(objAnch){
    now.placeholder = ``;
    healthy.placeholder = ``;
  }
}
/* [script:tokens] end */


/* ===== Mirror Sync (robust against extensions/overlays) ===== */
let _mirrorTick = null;
let _lastPrefObj = "";
let _lastPrefNow = "";
function syncMirror(force=false){
  try{
    const curObj = getObjectFull();
    const curNow = getDeviationFull();
    let changed = false;
    if(force || curObj !== _lastPrefObj){
      _lastPrefObj = curObj;
      if(objectIS && !objectISDirty){
        if(objectIS.value !== curObj){
          objectIS.value = curObj;
          autoResize(objectIS);
          changed = true;
        }
      }
    }
    if(force || curNow !== _lastPrefNow){
      _lastPrefNow = curNow;
      if(deviationIS && !deviationISDirty){
        if(deviationIS.value !== curNow){
          deviationIS.value = curNow;
          autoResize(deviationIS);
          changed = true;
        }
      }
    }
    if(changed || force){
      refreshAllTokenizedText();
      updateTitlesAndLabels();
      saveToStorage();
    }
  }catch(e){ /* no-op */ }
}
/* [script:init] start */
function autoResize(el){
  if(!el || el.tagName !== 'TEXTAREA') return;
  el.style.height = 'auto';
  const minH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ta-min-h')) || 140;
  el.style.height = Math.max(minH, el.scrollHeight, 140) + 'px';
}
function init(){
  initTable();
  restoreFromStorage();
  if(bridgeOpenedUtc && !bridgeOpenedUtc.value.trim()){
    bridgeOpenedUtc.value = new Date().toISOString();
    saveToStorage();
  }
  refreshAllTokenizedText();
  updateTitlesAndLabels();
  // Kick off periodic sync to capture extension-driven edits (e.g., Grammarly)
  if(!_mirrorTick){ _mirrorTick = setInterval(syncMirror, 300); }
  // Do an immediate sync so existing values populate
  syncMirror(true);
}
init();
/* [script:init] end */

/* [script:export] start */

/* =================== Summary Export (executive style, chat-friendly) =================== */

function ensureSummaryCard(){
  let card = document.getElementById('summaryCard');
  if(!card){
    const wrap = document.querySelector('.wrap');
    card = document.createElement('div');
    card.className = 'card';
    card.id = 'summaryCard';
    const h = document.createElement('h3'); h.textContent = 'Copy & Paste Summary';
    const pre = document.createElement('pre'); pre.id='summaryPre'; pre.style.whiteSpace='pre-wrap'; pre.style.font='13px/1.6 monospace'; pre.style.margin='0';
    card.appendChild(h); card.appendChild(pre);
    wrap.appendChild(card);
  }
  return card;
}

function valOrDash(s){ const v=(s||'').trim(); return v ? v : '—'; }
// Normalize user text into a single logical string for table cells (we’ll wrap visually in the table).
function inlineText(s){
  const v=(s||'').trim();
  if(!v) return '—';
  return v
    .split(/\r?\n/)
    .map(x=>x.trim())
    .filter(Boolean)
    .join(' · ');
}

function splitLines(text){
  const v=(text||'').trim();
  if(!v) return [];
  return v.split(/\r?\n/).map(line=>line.trim()).filter(Boolean);
}

function formatLabeledList(label, lines){
  if(!lines.length) return `${label}: —`;
  if(lines.length === 1) return `${label}: ${lines[0]}`;
  const bullets = lines.map(line=>`  • ${line}`).join('\n');
  return `${label}:\n${bullets}`;
}

function formatDistinctionChanges(distLines, changeLines){
  const len = Math.max(distLines.length, changeLines.length);
  if(len === 0) return 'Distinctions → Changes: —';
  if(len === 1){
    const left = distLines[0] || '—';
    const right = changeLines[0] || '—';
    return `Distinctions → Changes: ${left} → ${right}`;
  }
  const pairs = [];
  for(let i=0;i<len;i++){
    const left = distLines[i] || '—';
    const right = changeLines[i] || '—';
    pairs.push(`  • ${left} → ${right}`);
  }
  return ['Distinctions → Changes:', ...pairs].join('\n');
}

function formatChipsetSelections(list){
  const selected = list.filter(item=>item.el?.checked).map(item=>item.label);
  return selected.length ? selected.join(', ') : '—';
}

function containmentStatusText(){
  const status = getContainmentStatus();
  if(status==='mitigation') return 'Temporary mitigation applied';
  if(status==='restore') return 'Full restoration in progress';
  if(status==='none') return 'No action yet';
  return '—';
}

function formatCommLine(sentEl, tsEl, label){
  const sent = sentEl?.checked;
  const ts = valOrDash(tsEl?.value);
  return `${label}: ${sent ? 'Sent' : 'Not sent'}${ts && ts !== '—' ? ` @ ${ts}` : ''}`;
}

/* ---------- Executive summary builder ---------- */
function buildSummaryText(){
  const title = document.getElementById('docTitle').textContent.trim();
  const subtitle = document.getElementById('docSubtitle').textContent.trim();

  const bridge = [
    `Bridge Opened (UTC): ${valOrDash(bridgeOpenedUtc?.value)}`,
    `Incident Commander: ${valOrDash(icName?.value)}`,
    `Bridge Coordinator: ${valOrDash(bcName?.value)}`,
    `SEM/Ops Lead: ${valOrDash(semOpsName?.value)}`,
    `Severity: ${valOrDash(severity?.value)}`,
    `Next Update Due: ${valOrDash(nextUpdateDue?.value)}`
  ].join('\n');

  const detectionSummary = formatChipsetSelections([
    {el: detectMonitoring, label: 'Monitoring'},
    {el: detectUserReport, label: 'User Report'},
    {el: detectAutomation, label: 'Automation'},
    {el: detectOther, label: 'Other'}
  ]);

  const evidenceSummary = formatChipsetSelections([
    {el: evScreenshot, label: 'Screenshot'},
    {el: evLogs, label: 'Logs'},
    {el: evMetrics, label: 'Metrics'},
    {el: evRepro, label: 'Repro'},
    {el: evOther, label: 'Other'}
  ]);

  // === Preface (inline answers) ===
  const prefaceLines = [
    `• One-line: ${valOrDash(oneLine.value)}`,
    `• Evidence/Proof: ${inlineText(proof.value)}`,
    `• Specific Object: ${inlineText(objectPrefill.value || (objectIS?.value||''))}`,
    `• Healthy Baseline: ${inlineText(healthy.value)}`,
    `• Current State (What is happening now?): ${inlineText(now.value)}`,
    `• Detection Source: ${detectionSummary}`,
    `• Evidence Collected: ${evidenceSummary}`
  ];
  const preface = prefaceLines.join('\n');

  // === Impact (inline answers) ===
  const imp = [
    `Current Impact: ${inlineText(impactNow.value)}`,
    `Future Impact: ${inlineText(impactFuture.value)}`,
    `Timeframe: ${inlineText(impactTime.value)}`
  ].join('\n');

  const containment = [
    `Status: ${containmentStatusText()}`,
    `Description: ${valOrDash(containDesc?.value)}`
  ].join('\n');

  const communications = [
    formatCommLine(commInternalSent, commInternalTs, 'Internal Update'),
    formatCommLine(commExternalSent, commExternalTs, 'External Update'),
    `Next Update: ${valOrDash(commNextUpdateTime?.value)}`
  ].join('\n');

  // === KT Table as chat-friendly blocks per question ===
  const rowsOut = [];

  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.classList.contains('band')){
      rowsOut.push('');
      rowsOut.push(`== ${tr.textContent.trim()} ==`);
      return;
    }
    const q = tr.querySelector('th').textContent.trim();
    const t = tr.querySelectorAll('textarea');
    const isLines = splitLines(t[0].value);
    const notLines = splitLines(t[1].value);
    const distLines = splitLines(t[2].value);
    const changeLines = splitLines(t[3].value);

    // Question header
    rowsOut.push(`Q: ${q}`);
    rowsOut.push(formatLabeledList('IS', isLines));
    rowsOut.push(formatLabeledList('IS NOT', notLines));
    rowsOut.push(formatDistinctionChanges(distLines, changeLines));
  });

  const ktOut = rowsOut.join('\n\n'); // clear breathing room between tables

  // === Compose (minimal blank lines between major sections) ===
  return [
    title,
    subtitle,
    '',
    '— Bridge Activation —',
    bridge,
    '',
    '— Preface —',
    preface,
    '',
    '— Containment —',
    containment,
    '',
    '— Impact —',
    imp,
    '',
    '— Communications —',
    communications,
    '',
    '— KT IS / IS NOT —',
    ktOut
  ].join('\n');
}



async function onGenerateSummary(){
  const text = buildSummaryText();

  // Always render at bottom for manual copy
  const card = ensureSummaryCard();
  const pre = document.getElementById('summaryPre');
  pre.textContent = text;
  card.style.display = 'block';
  // Try clipboard copy (best effort)
  try{
    if(window.isSecureContext && navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      if(typeof showToast==='function'){ showToast('Summary updated & copied. It’s also shown below.'); }
    }else{
      if(typeof showToast==='function'){ showToast('Summary updated. Clipboard blocked — copy it from the bottom.'); }
    }
  }catch(_){
    if(typeof showToast==='function'){ showToast('Summary updated. Clipboard blocked — copy it from the bottom.'); }
  }
}

document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('genSummaryBtn');
  if(btn){ btn.addEventListener('click', onGenerateSummary); }
});

/* [script:export] end */

/* [script:storage] start */
/* =================== Autosave =================== */
const STORAGE_KEY='kt-intake-full-v2';
function getContainmentStatus(){
  if(containMitigation?.checked) return 'mitigation';
  if(containRestore?.checked) return 'restore';
  if(containNone?.checked) return 'none';
  return '';
}
function saveToStorage(){
  const data={ pre:{ oneLine:oneLine.value, proof:proof.value, objectPrefill:objectPrefill.value, healthy:healthy.value, now:now.value },
               impact:{ now:impactNow.value, future:impactFuture.value, time:impactTime.value },
               ops:{
                 bridgeOpenedUtc:bridgeOpenedUtc?.value||'',
                 icName:icName?.value||'',
                 bcName:bcName?.value||'',
                 semOpsName:semOpsName?.value||'',
                 severity:severity?.value||'',
                 nextUpdateDue:nextUpdateDue?.value||'',
                 detectMonitoring:!!detectMonitoring?.checked,
                 detectUserReport:!!detectUserReport?.checked,
                 detectAutomation:!!detectAutomation?.checked,
                 detectOther:!!detectOther?.checked,
                 evScreenshot:!!evScreenshot?.checked,
                 evLogs:!!evLogs?.checked,
                 evMetrics:!!evMetrics?.checked,
                 evRepro:!!evRepro?.checked,
                 evOther:!!evOther?.checked,
                 containStatus:getContainmentStatus(),
                 containDesc:containDesc?.value||'',
                 commInternalSent:!!commInternalSent?.checked,
                 commInternalTs:commInternalTs?.value||'',
                 commExternalSent:!!commExternalSent?.checked,
                 commExternalTs:commExternalTs?.value||'',
                 commNextUpdateTime:commNextUpdateTime?.value||''
               },
               table:[] };
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.classList.contains('band')){ data.table.push({band: tr.textContent.trim()}); return; }
    const t=tr.querySelectorAll('textarea');
    data.table.push({q: tr.querySelector('th').textContent.trim(), is:t[0].value, no:t[1].value, di:t[2].value, ch:t[3].value});
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function restoreFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
  const data = JSON.parse(raw);
  if(data.pre){
    oneLine.value=data.pre.oneLine||''; proof.value=data.pre.proof||'';
    objectPrefill.value=data.pre.objectPrefill||''; healthy.value=data.pre.healthy||'';
    now.value=data.pre.now||'';
    [oneLine,proof,objectPrefill,healthy,now].forEach(autoResize);
    if(objectPrefill.value && objectIS && !objectIS.value) { objectIS.value=objectPrefill.value; autoResize(objectIS); }
    if(now.value && deviationIS && !deviationIS.value) { deviationIS.value=now.value; autoResize(deviationIS); }
  }
  if(data.impact){
    impactNow.value=data.impact.now||''; impactFuture.value=data.impact.future||''; impactTime.value=data.impact.time||'';
    [impactNow,impactFuture,impactTime].forEach(autoResize);
  }
  if(data.ops){
    if(bridgeOpenedUtc){ bridgeOpenedUtc.value=data.ops.bridgeOpenedUtc||''; }
    if(icName){ icName.value=data.ops.icName||''; }
    if(bcName){ bcName.value=data.ops.bcName||''; }
    if(semOpsName){ semOpsName.value=data.ops.semOpsName||''; }
    if(severity){ severity.value=data.ops.severity||''; }
    if(nextUpdateDue){ nextUpdateDue.value=data.ops.nextUpdateDue||''; }
    if(detectMonitoring){ detectMonitoring.checked=!!data.ops.detectMonitoring; }
    if(detectUserReport){ detectUserReport.checked=!!data.ops.detectUserReport; }
    if(detectAutomation){ detectAutomation.checked=!!data.ops.detectAutomation; }
    if(detectOther){ detectOther.checked=!!data.ops.detectOther; }
    if(evScreenshot){ evScreenshot.checked=!!data.ops.evScreenshot; }
    if(evLogs){ evLogs.checked=!!data.ops.evLogs; }
    if(evMetrics){ evMetrics.checked=!!data.ops.evMetrics; }
    if(evRepro){ evRepro.checked=!!data.ops.evRepro; }
    if(evOther){ evOther.checked=!!data.ops.evOther; }
    if(containDesc){ containDesc.value=data.ops.containDesc||''; }
    if(typeof data.ops.containStatus==='string'){
      const status = data.ops.containStatus;
      if(containNone){ containNone.checked = status==='none'; }
      if(containMitigation){ containMitigation.checked = status==='mitigation'; }
      if(containRestore){ containRestore.checked = status==='restore'; }
    }
    if(commInternalSent){ commInternalSent.checked=!!data.ops.commInternalSent; }
    if(commInternalTs){ commInternalTs.value=data.ops.commInternalTs||''; }
    if(commExternalSent){ commExternalSent.checked=!!data.ops.commExternalSent; }
    if(commExternalTs){ commExternalTs.value=data.ops.commExternalTs||''; }
    if(commNextUpdateTime){ commNextUpdateTime.value=data.ops.commNextUpdateTime||''; }
  }
  if(Array.isArray(data.table)){
    let i=0;
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      if(tr.classList.contains('band')) return;
      const rec = data.table.find(d=>d.q===tr.querySelector('th').textContent.trim() && !d.band) || data.table[i++];
      if(!rec) return;
      const t = tr.querySelectorAll('textarea');
      t[0].value=rec.is||''; t[1].value=rec.no||''; t[2].value=rec.di||''; t[3].value=rec.ch||'';
      t.forEach(autoResize);
    });
  }
}
/* [script:storage] end */

/* [script:toast] start */
function showToast(msg){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show';
  setTimeout(()=>toast.classList.remove('show'), 2200);
}
/* [script:toast] end */
</script>
<!-- [script] end -->
</body>
</html>
