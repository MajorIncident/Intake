<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KT Intake</title>

<!--
[contract] start
EDITING CONTRACT for ChatGPT & humans:
- Keep these anchors intact. Prefer unified diffs (*** Begin Patch / *** End Patch) that edit INSIDE the relevant anchors only.
- Do not remove tokens: {OBJECT} / {DEVIATION}.
- Keep function names/signatures for copy to ASCII intact.
- Avoid structural rewrites unless requested; keep single-file layout.
Anchors present:
  [styles] [vars] [header] [section:preface] [subtitle]
  [section:impact] [section:table]
  [script] [rows] [script:table-build] [script:preface-refs]
  [script:tokens] [script:init] [script:export] [script:storage] [script:toast]
[contract] end
-->

<!-- [styles] start -->
<style>
  /* [vars] start */
  :root{
    /* Apple-like daytime palette */
    --bg:#f5f7fb;
    --panel:#ffffff;
    --ink:#0c1220;
    --muted:#5b6475;
    --line:#e6eaf2;
    --band:#f6f8fc;
    --accent:#007aff;

    /* Layout */
    --qcol-w:10.5rem;     /* narrow KT Question column */
    --ta-fs:15px;         /* textarea font size */
    --ta-min-h:380px;     /* taller by default */
    --radius:14px;
    --shadow:0 8px 24px rgba(12,18,32,.08), 0 1px 0 rgba(255,255,255,.6) inset;
    --speed:.22s;
  }
  /* [vars] end */

  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"SF Pro Text","SF Pro Display",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    font-size:15px; line-height:1.6; letter-spacing:-0.01em;
  }
  header{
    max-width:1240px; margin:22px auto 8px; padding:0 12px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  h1#docTitle{font-size:22px; font-weight:800; margin:0; letter-spacing:-0.01em; white-space:pre-wrap;}
  .subtle{color:var(--muted); font-size:12px;}
  .btn{
    appearance:none; border:1px solid var(--line); background:var(--accent); color:#fff;
    padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    transition:transform var(--speed), box-shadow var(--speed), border-color var(--speed);
    box-shadow:0 6px 18px rgba(0,122,255,.18);
  }
  .btn:hover{transform:translateY(-1px);}

  .wrap{max-width:1240px; margin:0 auto 40px; padding:0 12px;}
  h2#docSubtitle{margin:12px 0 8px; font-size:16px; font-weight:700; color:#2a3957; white-space:pre-wrap;}

  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:20px 22px 24px; margin:0 0 32px;
  }
  .card h3{
    margin:0 0 16px;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,ui-sans-serif;
    font-size:15px; font-weight:700; letter-spacing:.32px; text-transform:uppercase; color:#1d2845;
  }
  .preface-stack{display:flex; flex-direction:column;}
  .grid{ display:grid; gap:12px; }
  .grid.cols-2{ grid-template-columns:1fr 1fr; }
  .grid.cols-3{ grid-template-columns:1fr 1fr 1fr; }
  .gap-24{ gap:24px; }
  .field label{display:block; font-weight:700; margin-bottom:6px;}
  .field small{display:block; color:var(--muted); margin-top:4px;}
  .field textarea, .field input[type="text"]{
    width:100%; box-sizing:border-box;
    font:15px/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:12px 14px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  .field textarea{min-height:140px; resize:vertical;}
  .field input[type="text"]{height:44px;}
  .field textarea::placeholder, .field input::placeholder{color:#8b93a4;}
  .field textarea:focus, .field input:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#fff;}

  /* Impact strip */
  .impact{ padding:18px; }
  .impact > h3{
    margin:0 0 18px;
    font-size:17px;
    font-weight:700;
    letter-spacing:-0.02em;
    color:#1f2b40;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  .impact .field{padding:4px 0;}
  .impact .field h3{
    margin:0 0 6px;
    font-size:15px;
    font-weight:600;
    letter-spacing:-0.015em;
    color:#22324b;
    font-family:"SF Pro Display","SF Pro Text",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  .impact .field label{
    font-size:13px;
    font-weight:600;
    letter-spacing:-0.01em;
    color:#3b4962;
    margin-bottom:8px;
  }
  .impact .field small{
    font-size:12px;
    line-height:1.55;
    letter-spacing:0;
  }
  .impact textarea{
    font-family:"SF Pro Text","SF Pro Display",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    font-size:14px;
    line-height:1.6;
    letter-spacing:-0.01em;
  }

  /* Table */
  table{
    width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:var(--radius);
    background:var(--panel); border:1px solid var(--line); box-shadow:var(--shadow);
  }
  thead th{
    position:sticky; top:0; z-index:3;
    background:linear-gradient(180deg, #ffffff, #fafbfe);
    color:#0c1220; text-align:left; font-size:12px; letter-spacing:.4px;
    padding:12px; border-bottom:1px solid var(--line);
  }
  tbody td, tbody th{
    border-bottom:1px solid var(--line); vertical-align:top; padding:10px 8px; transition:background-color var(--speed);
  }
  tbody tr:last-child td, tbody tr:last-child th{border-bottom:0;}
  tbody tr:hover td, tbody tr:hover th{background-color:#fafbfe;}
  tbody th{
    width:var(--qcol-w); max-width:var(--qcol-w); min-width:var(--qcol-w);
    white-space:normal; word-break:break-word; font-weight:700; color:#0c1220;
  }
  .band th{
    padding:12px; font-weight:800; color:#2a3957;
    background:linear-gradient(180deg, var(--band), #ffffff);
    border-top:1px solid var(--line); border-bottom:1px solid var(--line);
  }
  .band th span{opacity:.85; font-weight:600; color:#6b768a}
  textarea.tableta{
    width:100%; min-height:var(--ta-min-h); resize:vertical; box-sizing:border-box;
    font:var(--ta-fs)/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    color:var(--ink); background:#f9fbff;
    border:1px solid #dfe5f2; border-radius:12px; padding:12px 14px; outline:none;
    transition:border-color var(--speed), box-shadow var(--speed), background var(--speed);
  }
  textarea.tableta::placeholder{color:#8b93a4;}
  textarea.tableta:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(0,122,255,.18); background:#ffffff;}

  /* Toast */
  .toast{
    position:fixed; right:18px; bottom:18px; background:#0f1a10; color:#dff5e1; border:1px solid #164f19;
    padding:10px 12px; border-radius:12px; opacity:0; transform:translateY(10px); transition:.25s; pointer-events:none; box-shadow:var(--shadow);
  }
  .toast.show{opacity:1; transform:translateY(0);}
</style>
<!-- [styles] end -->
</head>
<body>
  <!-- [header] start -->
  <header>
    <h1 id="docTitle">KT Intake</h1>
    <button class="btn" id="copyBtn">Copy as Text</button>
  </header>
  <!-- [header] end -->

  <div class="wrap">
    <!-- [section:preface] start -->
    <section class="preface-stack">
      <div class="card">
        <h3>Problem Summary</h3>
        <div class="grid">
          <div class="field">
            <label for="oneLine">In one sentence, what is broken for you right now?</label>
            <textarea id="oneLine" placeholder=""></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Evidence &amp; Object</h3>
        <div class="grid cols-2">
          <div class="field">
            <label for="proof">What proves a deviation exists?</label>
            <small>Examples: alerts, error messages, metric spikes/drops, log lines, screenshots, reproducible steps.</small>
            <textarea id="proof" placeholder=""></textarea>
          </div>
          <div class="field">
            <label for="objectPrefill">What is the specific object being affected?</label>
            <small>Hardware name and model, Function/Module/Method, Container/Service/API, datastore/volume/bucket/table, network element, identity/policy/role, pipeline/job.</small>
            <textarea id="objectPrefill" placeholder=""></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Baseline vs Current</h3>
        <div class="grid cols-2">
          <div class="field">
            <label id="labelHealthy" for="healthy">What does healthy look like here?</label>
            <small>What was the expected behavior?</small>
            <textarea id="healthy" placeholder=""></textarea>
          </div>
          <div class="field">
            <label id="labelNow" for="now">What is happening now?</label>
            <small>What has been verified and measured vs same baseline (same metrics as above)? What symptom is being presented?</small>
            <textarea id="now" placeholder=""></textarea>
          </div>
        </div>
      </div>
    </section>
    <!-- [section:preface] end -->

    <!-- [subtitle] start -->
    <h2 id="docSubtitle">Describe The Problem</h2>
    <!-- [subtitle] end -->

    <!-- [section:impact] start -->
    <div class="card impact">
      <h3>Impact</h3>
      <div class="grid cols-3 gap-24">
        <div class="field">
          <h3>Current Impact</h3>
          <label for="impactNow">Current Impact</label>
          <small>Who/what is affected now? Quantify: users/tenants/regions, transactions failing, SLI/SLO deltas (avail %, p95/p99, error %), data at risk (loss/corruption/exposure), workarounds.</small>
          <textarea id="impactNow" placeholder=""></textarea>
        </div>
        <div class="field">
          <h3>Future Impact</h3>
          <label for="impactFuture">Future Impact</label>
          <small>If unresolved what happens? Blast radius growth, SLO/SLA breach, revenue/penalties, compliance, backlog/consumer lag, churn, on-call fatigue.</small>
          <textarea id="impactFuture" placeholder=""></textarea>
        </div>
        <div class="field">
          <h3>Timeframe</h3>
          <label for="impactTime">Timeframe</label>
          <small>When will the Future Impact become Current Impact? (Best Estimate). What deadlines/SLAs do we need to be aware of?</small>
          <textarea id="impactTime" placeholder=""></textarea>
        </div>
      </div>
    </div>
    <!-- [section:impact] end -->

    <!-- [section:table] start -->
    <p class="subtle">Problem Analysis</p>

    <table id="ktTable" aria-label="KT IS / IS NOT intake table">
      <thead>
        <tr>
          <th scope="col">KT Question</th>
          <th scope="col">IS <span class="subtle">— facts only</span></th>
          <th scope="col">IS NOT <span class="subtle">— similar &amp; reasonable and could be but is not occuring</span></th>
          <th scope="col">Distinctions <span class="subtle">— Unique characteristics about the IS</span></th>
          <th scope="col">Changes <span class="subtle">— Changes that happened in on around or about each Distinction</span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <!-- [section:table] end -->
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- [script] start -->
<script>
/* [rows] start */
/* =================== Core data & prompts (KT Problem Analysis) =================== */
/* Use {OBJECT} / {DEVIATION} tokens anywhere you want auto-fill. */
const ROWS = [
  { band: "WHAT", note: "Define the problem precisely (Object & Deviation)." },

  {
    q: "WHAT — Object / Thing",
    isPH:
      "What specific object has {DEVIATION}?\n• Name/ID (service/app/workload)\n• Version/build/OS/patch\n• Endpoint/feature/module\n• Key dependencies (DB/cache/queue/API)\n• Environment (prod/stage/dev)",
    notPH:
      "What similar objects could do NOT have {DEVIATION}?\n• Same build in other node/AZ/cluster\n• Other tenants/namespaces\n• Other instances/pods/LB pools"
  },
  {
    q: "WHAT — Deviation or Symptom does the {OBJECT} have?",
    isPH:
      "What exactly is the deviation?\n• Symptom (error text/code), timestamp\n• Evidence (log line, trace/span IDs, health checks)\n• Expected vs actual result",
    notPH:
      "What close-by symptoms are NOT present?\n• No timeouts? No 5xx? No OOM?\n• No CPU/disk/network saturation"
  },

  { band: "WHERE", note: "Locate the problem (geography/topology and on the object)." },

  {
    q: "WHERE — is the {OBJECT} Geographically / Topology",
    isPH:
      "Where is {OBJECT} when {DEVIATION} occurs?\n• Cloud/Region/AZ, VPC/Subnet\n• Failing hop (client→edge/CDN→WAF/LB→mesh→app→DB)",
    notPH:
      "Where would you reasonably expect {DEVIATION} but do NOT see it?\n• Other Region/AZ/VPC\n• Other node pool/namespace\n• Other ISP/branch/site"
  },
  {
    q: "WHERE — On the {OBJECT}",
    isPH:
      "Where on {OBJECT} is {DEVIATION} seen?\n• Module/class/handler\n• Screen/step/endpoint\n• Table/index/partition/topic shard\n• Log file+line / span location",
    notPH:
      "What neighboring parts do NOT show {DEVIATION}?\n• Other layers/steps\n• Auth passes; reads OK vs writes fail"
  },

  { band: "WHEN", note: "Timing and change (first seen, pattern, life-cycle; what changed)." },

  {
    q: "WHEN — Was the {DEVIATION} First seen",
    isPH:
      "When was {DEVIATION} first observed for {OBJECT}? (date/time/zone)\nHas it worked before?\n• Last known good (build/commit + timestamp)",
    notPH:
      "When might it reasonably have appeared but did NOT?"
  },
  {
    q: "WHEN — Since was the {DEVIATION} logged? What Pattern?",
    isPH:
      "Since first occurrence, when does {DEVIATION} appear?\n• All windows (start/stop)\n• Pattern (continuous/periodic/sporadic; bursts; top-of-hour; load/time correlation)",
    notPH:
      "Similar windows/patterns that do NOT occur"
  },
  {
    q: "WHEN — Describe using words When the {DEVIATION} was first seen",
    isPH:
      "At what point in {OBJECT}’s life-cycle did {DEVIATION} appear?\n• Deploy/rollback/feature flag\n• Config/secret/cert rotation\n• Autoscale/startup/cache warm\n• GC/compaction/failover/rebalance\nWhat changed near first occurrence or between IS and IS NOT?",
    notPH:
      "Adjacent life-cycle moments without {DEVIATION}"
  },

  { band: "EXTENT", note: "How big is it? Magnitude, count, scope, trend." },

  {
    q: "EXTENT — What is the population or size of {OBJECT} affected?",
    isPH:
      "How many {OBJECT}s have {DEVIATION}? Trend (↑/↓/stable)?\n• Affected pods/hosts/tenants/users\n• Which versions/builds",
    notPH:
      "Comparable object sets not affected"
  },
  {
    q: "EXTENT — What is the size of a single {DEVIATION}?",
    isPH:
      "How big is a single {DEVIATION} on {OBJECT}?\n• Latency delta, error %, throughput/availability impact\nTrend (↑/↓/stable)?",
    notPH:
      "Similar metrics that are NOT worse/not changing"
  },
  {
    q: "EXTENT — How many {DEVIATION} are occuring on each {OBJECT}?",
    isPH:
      "How many instances per {OBJECT}? (e.g., errors/min per instance)\nTrend (↑/↓/stable)?",
    notPH:
      "Comparable rates that do NOT occur"
  },
];

/* [rows] end */

/* [script:table-build] start */
/* =================== Build table & dynamic tokens =================== */
const tbody = document.getElementById('tbody');
const rowsBuilt = [];
let objectIS = null;     // first WHAT → IS
let deviationIS = null;  // second WHAT → IS

function mkBand(title, note){
  const tr = document.createElement('tr'); tr.className='band';
  const th = document.createElement('th'); th.colSpan = 5; th.innerHTML = `${title} <span>— ${note}</span>`;
  tr.appendChild(th); return tr;
}
function mkRow(def, i){
  const tr = document.createElement('tr'); tr.dataset.row = i;
  const th = document.createElement('th'); th.scope='row'; th.textContent = fillTokens(def.q);

  const tdIS = document.createElement('td');
  const tdNOT = document.createElement('td');
  const tdDIST = document.createElement('td');
  const tdCHG = document.createElement('td');

  const isTA  = document.createElement('textarea'); isTA.className='tableta';
  const notTA = document.createElement('textarea'); notTA.className='tableta';
  const distTA= document.createElement('textarea'); distTA.className='tableta';
  const chgTA = document.createElement('textarea'); chgTA.className='tableta';

  isTA.placeholder   = fillTokens(def.isPH || "");
  notTA.placeholder  = mkIsNotPH(fillTokens(def.notPH || ""), "");
  distTA.placeholder = mkDistPH("", "");
  chgTA.placeholder  = mkChangePH("");

  const refreshIsNotPH = ()=> notTA.placeholder = mkIsNotPH(fillTokens(def.notPH||""), isTA.value);
  const refreshDistPH  = ()=> distTA.placeholder = mkDistPH(isTA.value, notTA.value);
  const refreshChgPH   = ()=> chgTA.placeholder  = mkChangePH(distTA.value);

  [isTA,notTA,distTA].forEach(t=>t.addEventListener('input', ()=>{
    autoResize(t);
    if(t===isTA){ refreshIsNotPH(); refreshDistPH(); }
    if(t===notTA){ refreshDistPH(); }
    if(t===distTA){ refreshChgPH(); }
    saveToStorage();
  }));
  [isTA,notTA,distTA,chgTA].forEach(t=>{ autoResize(t); t.addEventListener('input', saveToStorage); });

  tdIS.appendChild(isTA); tdNOT.appendChild(notTA); tdDIST.appendChild(distTA); tdCHG.appendChild(chgTA);
  tr.append(th, tdIS, tdNOT, tdDIST, tdCHG);

  rowsBuilt.push({tr, th, def, isTA, notTA, distTA, chgTA});
  return tr;
}
function initTable(){
  let dataRowCount = 0;
  ROWS.forEach((def)=>{
    if(def.band){ tbody.appendChild(mkBand(def.band, def.note||'')); }
    else{
      const tr = mkRow(def, ++dataRowCount);
      tbody.appendChild(tr);
      if(dataRowCount===1) objectIS   = rowsBuilt[rowsBuilt.length-1].isTA;  // first data row IS
      if(dataRowCount===2) deviationIS= rowsBuilt[rowsBuilt.length-1].isTA;  // second data row IS
    }
  });

  [objectIS, deviationIS].forEach(el=>{
    el.addEventListener('input', ()=>{
      refreshAllTokenizedText();
      updateTitlesAndLabels();
      saveToStorage();
    });
  });
}
/* [script:table-build] end */

/* [script:preface-refs] start */
/* =================== Preface helpers & H1/H2 =================== */
const oneLine = document.getElementById('oneLine');
const proof = document.getElementById('proof');
const objectPrefill = document.getElementById('objectPrefill');
const healthy = document.getElementById('healthy');
const now = document.getElementById('now');

const labelHealthy = document.getElementById('labelHealthy');
const labelNow = document.getElementById('labelNow');

const docTitle = document.getElementById('docTitle');
const docSubtitle = document.getElementById('docSubtitle');

const impactNow = document.getElementById('impactNow');
const impactFuture = document.getElementById('impactFuture');
const impactTime = document.getElementById('impactTime');

[oneLine, proof, objectPrefill, healthy, now].forEach(el=>{
  el.addEventListener('input', ()=>{
    // If the table fields are empty, seed them from preface
    if(el===objectPrefill && objectIS && !objectIS.value.trim()){
      objectIS.value = el.value.trim(); autoResize(objectIS);
      refreshAllTokenizedText();
    }
    if(el===now && deviationIS && !deviationIS.value.trim()){
      deviationIS.value = el.value.trim(); autoResize(deviationIS);
      refreshAllTokenizedText();
    }
    if(el===oneLine && deviationIS && !deviationIS.value.trim()){
      deviationIS.value = el.value.trim(); autoResize(deviationIS);
      refreshAllTokenizedText();
    }
    updateTitlesAndLabels();
    saveToStorage();
  });
});
/* [script:preface-refs] end */

/* [script:tokens] start */
function firstSnippet(v){
  const s = (v||'').trim();
  if(!s) return '';
  return s.split(/\n|\. /)[0].slice(0,120);
}
function compactOneLine(str, max=90){
  const s = (str||'').trim().replace(/\s+/g,' ');
  return s.length>max ? s.slice(0,max-1)+'…' : s;
}
function getObjectFull(){
  return (objectPrefill.value || objectIS?.value || '').trim();
}
function getDeviationFull(){
  // Treat "What is happening now?" as the deviation for the problem statement.
  return (now.value || deviationIS?.value || '').trim();
}
function objectAnchor(){
  // Use a compact anchor for labels (not the full paragraph to keep labels readable)
  const src = getObjectFull() || 'the object';
  return compactOneLine(src, 80);
}
function fillTokens(text){
  const obj = firstSnippet(objectIS?.value)    || firstSnippet(getObjectFull()) || 'the object';
  const dev = firstSnippet(deviationIS?.value) || firstSnippet(getDeviationFull()) || 'the deviation';
  return (text||'').replace(/\{OBJECT\}/g, '“'+obj+'”').replace(/\{DEVIATION\}/g, '“'+dev+'”');
}
function mkIsNotPH(baseCopy, isVal){
  const base = (baseCopy||'').trim();
  const isSnippet = firstSnippet(isVal);
  if(isSnippet){
    const prompt = fillTokens(``);
    return base ? `${prompt}\n\n${base}` : prompt;
  }
  return base || fillTokens('');
}
function mkDistPH(isVal, notVal){
  const base = fillTokens('');
  const isSnippet = firstSnippet(isVal);
  const notSnippet = firstSnippet(notVal);
  const parts = [];
  if(isSnippet){ parts.push(`What is different, odd, special, or uniquely true about “${isSnippet}”?`); }
  if(notSnippet){ parts.push(`Only list traits that are not shared by “${notSnippet}”`); }
  const lead = parts.length ? parts.join(' ') + '' : '';
  return lead ? `${lead}\n${base}` : base;
}
function mkChangePH(distText){
  const base = fillTokens('');
  const distSnippet = firstSnippet(distText);
  if(distSnippet){
    return `What changed in, on, around, or about “${distSnippet}”, Ask this question for each distinction listed.\n${base}`;
  }
  return base;
}
function refreshAllTokenizedText(){
  rowsBuilt.forEach(({th, def, isTA, notTA})=>{
    th.textContent = fillTokens(def.q);
    isTA.placeholder  = fillTokens(def.isPH||"");
    notTA.placeholder = mkIsNotPH(fillTokens(def.notPH||""), isTA.value);
  });
}
function updateTitlesAndLabels(){
  const objFull = getObjectFull();
  const devFull = getDeviationFull();
  const objAnch = objectAnchor();

  if(objFull && devFull){
    // H1/H2 use the FULL text as requested (concatenated)
    docTitle.textContent = `${objFull} — ${devFull}`;
    docSubtitle.textContent = `What is happening now to ${objAnch}: ${devFull}`;
    document.title = `${compactOneLine(objFull, 50)} — ${compactOneLine(devFull, 50)} · KT Intake`;
  }else{
    docTitle.textContent = "KT Intake";
    docSubtitle.textContent = "Describe Problem";
    document.title = "KT Intake";
  }

  // Dynamic labels for Healthy/Now
  labelNow.textContent = objAnch ? `What is happening now to ${objAnch}?` : "What is happening now?";
  labelHealthy.textContent = objAnch ? `What does healthy look like here for ${objAnch}?` : "What does healthy look like?";

  // (Optional) adjust placeholders subtly to reflect anchor
  if(objAnch){
    now.placeholder = ``;
    healthy.placeholder = ``;
  }
}
/* [script:tokens] end */

/* [script:init] start */
function autoResize(el){
  el.style.height = 'auto';
  const minH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ta-min-h'));
  el.style.height = Math.max(minH, el.scrollHeight, el.tagName==='TEXTAREA' ? 140 : 44) + 'px';
}
function init(){
  initTable();
  restoreFromStorage();
  refreshAllTokenizedText();
  updateTitlesAndLabels();
}
init();
/* [script:init] end */

/* [script:export] start */
/* =================== ASCII export =================== */
function wrapAt(str, width){
  if(!str) return '';
  const words = str.split(/\s+/); let line = '', out = [];
  words.forEach(w=>{
    if((line + ' ' + w).trim().length > width){ if(line) out.push(line); line = w; }
    else{ line = (line? line+' ' : '') + w; }
  });
  if(line) out.push(line);
  return out.join('\n');
}
function asciiBlock(title, body){
  let b = (body||'—').trim();
  return `> ${title}\n${b}\n\n`;
}
function toAscii(){
  /* Titles built from FULL object + FULL now */
  const title = document.getElementById('docTitle').textContent.trim();
  const subtitle = document.getElementById('docSubtitle').textContent.trim();

  /* Preface fields */
  const preface = [
    asciiBlock('One-sentence', oneLine.value),
    asciiBlock('Evidence / Proof', proof.value),
    asciiBlock('Specific Object', objectPrefill.value || (objectIS?.value||'')),
    asciiBlock('Healthy Baseline', healthy.value),
    asciiBlock('Current State (What is happening now?)', now.value),
  ].join('');

  /* Impact table */
  const impactHeaders = ["Current Impact","Future Impact","Timeframe"];
  const impactCells = [impactNow.value.trim()||"—", impactFuture.value.trim()||"—", impactTime.value.trim()||"—"];
  const impW = [0,0,0];
  impactHeaders.forEach((h,i)=>impW[i]=Math.max(impW[i], h.length));
  impactCells.forEach((c,i)=>c.split('\n').forEach(l=>impW[i]=Math.max(impW[i], l.length)));
  const pad=(s,w)=> s + ' '.repeat(w - s.length);
  const barImp='+'+impW.map(w=>'-'.repeat(w+2)).join('+')+'+';
  let impactOut = barImp+'\n';
  impactOut += '|' + impactHeaders.map((h,i)=>' '+pad(h,impW[i])+' ').join('|') + '|\n';
  impactOut += barImp+'\n';
  const maxLines = Math.max(...impactCells.map(c=>c.split('\n').length));
  for(let i=0;i<maxLines;i++){
    impactOut += '|' + [0,1,2].map(ci=>{
      const lines = impactCells[ci].split('\n');
      return ' '+pad(lines[i]||'', impW[ci])+' ';
    }).join('|') + '|\n';
  }
  impactOut += barImp+'\n\n';

  /* KT table */
  const headers = ["KT Question","IS","IS NOT","Distinctions","Changes"];
  const rows = [];
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.classList.contains('band')){
      rows.push({band: tr.textContent.trim()});
      return;
    }
    const q = tr.querySelector('th').textContent.trim();
    const t = tr.querySelectorAll('textarea');
    const is = t[0].value.trim(), no = t[1].value.trim(), di = t[2].value.trim(), ch = t[3].value.trim();
    const dLines = di.split('\n').map(s=>s.trim()).filter(Boolean);
    let cLines = ch.split('\n').map(s=>s.trim()).filter(Boolean);
    if(dLines.length && cLines.length < dLines.length){
      const missing = dLines.slice(cLines.length);
      cLines = cLines.concat(missing.map(s=>`[TODO] What changed re: ${s}?`));
    }
    rows.push({
      q: wrapAt(q, 26),
      is: is || "—",
      no: no || "—",
      di: dLines.length ? dLines.join('\n') : "—",
      ch: cLines.length ? cLines.join('\n') : (dLines.length ? "[TODO] Map changes to each distinction above" : "—"),
    });
  });

  const colW = [0,0,0,0,0];
  const widen=(i,s)=>s.split('\n').forEach(l=>colW[i]=Math.max(colW[i], l.length));
  headers.forEach((h,i)=>widen(i,h));
  rows.forEach(r=>{ if(r.band) return; widen(0,r.q); widen(1,r.is); widen(2,r.no); widen(3,r.di); widen(4,r.ch); });
  const bar='+'+colW.map(w=>'-'.repeat(w+2)).join('+')+'+';

  let ktOut = bar+'\n';
  ktOut += '|' + headers.map((h,i)=>' '+pad(h,colW[i])+' ').join('|') + '|\n';
  ktOut += bar+'\n';
  rows.forEach(r=>{
    if(r.band){ ktOut += bar+'\n' + `== ${r.band} ==\n` + bar+'\n'; return; }
    const cells=[r.q.split('\n'), r.is.split('\n'), r.no.split('\n'), r.di.split('\n'), r.ch.split('\n')];
    const max=Math.max(...cells.map(c=>c.length));
    for(let i=0;i<max;i++){
      ktOut+='|' + [0,1,2,3,4].map(ci=>' '+pad(cells[ci][i]||'', colW[ci])+' ').join('|') + '|\n';
    }
    ktOut+=bar+'\n';
  });

  /* Combine */
  let out = '';
  out += title + '\n';
  out += subtitle + '\n\n';
  out += preface;
  out += 'IMPACT\n' + impactOut;
  out += 'KT IS / IS NOT — Details\n' + ktOut;
  return out;
}
async function copyAscii(){
  const ascii = toAscii();

  // Helper: legacy fallback that works on HTTP and older browsers
  const legacyCopy = () => {
    try{
      const ta = document.createElement('textarea');
      ta.value = ascii;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      if(ok){ showToast('Copied as ASCII. Paste into your ticket ✨'); return true; }
      return false;
    }catch(_){ return false; }
  };

  try{
    if(window.isSecureContext && navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(ascii);
      showToast('Copied as ASCII. Paste into your ticket ✨');
      return;
    }
    // Not secure or API missing → try legacy
    if(legacyCopy()) return;
    // Last resort: render in-page for manual copy (no popup windows)
    const pre = document.createElement('pre');
    pre.style.whiteSpace='pre-wrap';
    pre.style.font='13px/1.5 monospace';
    pre.style.margin='0';
    pre.style.padding='16px';
    pre.style.maxHeight='60vh';
    pre.style.overflow='auto';
    pre.textContent = ascii;

    const modal = document.createElement('div');
    modal.style.position='fixed';
    modal.style.inset='24px';
    modal.style.background='rgba(0,0,0,.35)';
    modal.style.backdropFilter='blur(2px)';
    modal.style.zIndex='9999';
    modal.addEventListener('click', e=>{ if(e.target===modal) modal.remove(); });

    const card = document.createElement('div');
    card.style.background='#fff';
    card.style.border='1px solid #e6eaf2';
    card.style.borderRadius='12px';
    card.style.boxShadow='0 8px 24px rgba(12,18,32,.12)';
    card.style.maxWidth='960px';
    card.style.margin='auto';
    card.style.padding='12px';
    card.style.height='70vh';
    card.style.display='flex';
    card.style.flexDirection='column';
    card.innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 8px 12px 8px;"><strong style="font:600 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">KT — ASCII Export (manual copy)</strong><button id="closeAscii" class="btn" style="padding:6px 10px;border-radius:8px;">Close</button></div>';
    card.appendChild(pre);
    modal.appendChild(card);
    document.body.appendChild(modal);
    document.getElementById('closeAscii').addEventListener('click', ()=>modal.remove());
    showToast('Clipboard blocked. Showing text to copy manually.');
  }catch(e){
    // If anything unexpected happens, try legacy then bail gracefully
    if(legacyCopy()) return;
    showToast('Couldn’t access clipboard. Are you on HTTPS and not inside a sandbox?');
    console.error('Copy failed:', e);
  }
}
document.getElementById('copyBtn').addEventListener('click', copyAscii);
/* [script:export] end */

/* [script:storage] start */
/* =================== Autosave =================== */
const STORAGE_KEY='kt-intake-full-v2';
function saveToStorage(){
  const data={ pre:{ oneLine:oneLine.value, proof:proof.value, objectPrefill:objectPrefill.value, healthy:healthy.value, now:now.value },
               impact:{ now:impactNow.value, future:impactFuture.value, time:impactTime.value },
               table:[] };
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    if(tr.classList.contains('band')){ data.table.push({band: tr.textContent.trim()}); return; }
    const t=tr.querySelectorAll('textarea');
    data.table.push({q: tr.querySelector('th').textContent.trim(), is:t[0].value, no:t[1].value, di:t[2].value, ch:t[3].value});
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function restoreFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
  const data = JSON.parse(raw);
  if(data.pre){
    oneLine.value=data.pre.oneLine||''; proof.value=data.pre.proof||'';
    objectPrefill.value=data.pre.objectPrefill||''; healthy.value=data.pre.healthy||'';
    now.value=data.pre.now||'';
    [oneLine,proof,objectPrefill,healthy,now].forEach(autoResize);
    if(objectPrefill.value && objectIS && !objectIS.value) { objectIS.value=objectPrefill.value; autoResize(objectIS); }
    if(now.value && deviationIS && !deviationIS.value) { deviationIS.value=now.value; autoResize(deviationIS); }
  }
  if(data.impact){
    impactNow.value=data.impact.now||''; impactFuture.value=data.impact.future||''; impactTime.value=data.impact.time||'';
    [impactNow,impactFuture,impactTime].forEach(autoResize);
  }
  if(Array.isArray(data.table)){
    let i=0;
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      if(tr.classList.contains('band')) return;
      const rec = data.table.find(d=>d.q===tr.querySelector('th').textContent.trim() && !d.band) || data.table[i++];
      if(!rec) return;
      const t = tr.querySelectorAll('textarea');
      t[0].value=rec.is||''; t[1].value=rec.no||''; t[2].value=rec.di||''; t[3].value=rec.ch||'';
      t.forEach(autoResize);
    });
  }
}
/* [script:storage] end */

/* [script:toast] start */
function showToast(msg){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show';
  setTimeout(()=>toast.classList.remove('show'), 2200);
}
/* [script:toast] end */
</script>
<!-- [script] end -->
</body>
</html>
