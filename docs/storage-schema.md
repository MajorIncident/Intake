# Storage Schema

_Auto-generated by `scripts/update-storage-docs.js`. Do not edit this file manually._

- Current `APP_STATE_VERSION`: 1
- Total tracked fields: 52

## Migrations

| From version | Migrator |
| --- | --- |
| 0 | `migrateLegacyState` |

## Field definitions

| Field | Type | Introduced |
| --- | --- | --- |
| `actions` | object | 1 |
| `actions.analysisId` | string | 1 |
| `actions.items` | array | 1 |
| `appearance` | object | 1 |
| `appearance.theme` | string | 1 |
| `causes` | array | 1 |
| `handover` | object | 1 |
| `handover.current-state` | array | 1 |
| `handover.must-watch-metrics` | array | 1 |
| `handover.remaining-risks` | array | 1 |
| `handover.what-changed` | array | 1 |
| `handover.whats-next` | array | 1 |
| `impact` | object | 1 |
| `impact.future` | string | 1 |
| `impact.now` | string | 1 |
| `impact.time` | string | 1 |
| `likelyCauseId` | null | 1 |
| `meta` | object | 1 |
| `meta.savedAt` | null | 1 |
| `meta.version` | number | 1 |
| `ops` | object | 1 |
| `ops.bcName` | string | 1 |
| `ops.bridgeOpenedUtc` | string | 1 |
| `ops.commCadence` | string | 1 |
| `ops.commLog` | array | 1 |
| `ops.commNextDueIso` | string | 1 |
| `ops.commNextUpdateTime` | string | 1 |
| `ops.containDesc` | string | 1 |
| `ops.containStatus` | string | 1 |
| `ops.detectAutomation` | boolean | 1 |
| `ops.detectMonitoring` | boolean | 1 |
| `ops.detectOther` | boolean | 1 |
| `ops.detectUserReport` | boolean | 1 |
| `ops.evLogs` | boolean | 1 |
| `ops.evMetrics` | boolean | 1 |
| `ops.evOther` | boolean | 1 |
| `ops.evRepro` | boolean | 1 |
| `ops.evScreenshot` | boolean | 1 |
| `ops.icName` | string | 1 |
| `ops.semOpsName` | string | 1 |
| `ops.severity` | string | 1 |
| `ops.tableFocusMode` | string | 1 |
| `pre` | object | 1 |
| `pre.healthy` | string | 1 |
| `pre.now` | string | 1 |
| `pre.objectPrefill` | string | 1 |
| `pre.oneLine` | string | 1 |
| `pre.proof` | string | 1 |
| `steps` | object | 1 |
| `steps.drawerOpen` | boolean | 1 |
| `steps.items` | array | 1 |
| `table` | array | 1 |


## Template payloads and drawer workflow

The storage schema documentation doubles as the contract for curated template payloads. Templates are authored as JSON files under `templates/`, then compiled into `src/templates.manifest.js` via `npm run build:templates`. The runtime drawer (`src/templates.js`) hydrates that manifest, normalises each template's stored `SerializedAppState`, and projects a payload per mode so the UI can safely prefill new intakes.

### Authoring checklist

1. Start from an existing template JSON file so required keys (`id`, `name`, `description`, `templateKind`, `supportedModes`, and `state`) stay in place.
2. Ensure `state` mirrors the fields listed above, including nested objects for `pre`, `impact`, `ops`, `steps`, and `actions`.
3. Keep drawer labels short—the template list truncates anything overly long.
4. Run `npm run build:templates` after editing JSON so `src/templates.manifest.js` refreshes.
5. Run `npm run update:storage-docs` to verify new fields are documented.

### Drawer workflow

- `src/templates.js` normalises template payloads, guaranteeing arrays are cloned and booleans such as `steps.drawerOpen` default to `false`.
- Mode projections enforce the `MODE_RULES` contract—fields hidden in a mode are reset to safe defaults before the drawer sends state to the app. The KT table honours the same per-column `tableFields` map so IS / IS NOT only prefills IS/IS NOT, D&C adds distinctions/changes while keeping causes/actions empty, and Full exposes all rows plus actions.
- Actions and steps collections are scrubbed before exposure so tests and runtime code can assume they conform to the schema defined above.

Keeping these guardrails in the appendix allows future guidance for template authors to live beside the generated schema without being overwritten each time the docs regenerate.

## Storage-to-Module Responsibility Map

Refer back to [`docs/storage-schema.md`](storage-schema.md) for the canonical field definitions. The table below groups every persisted field by the module and DOM anchor that owns it so you can jump straight to the implementation responsible for saving or restoring that data.

### Preface, impact, and bridge activation (`src/preface.js`)

- **Anchors / DOM roots:** `<!-- [section:preface] -->`, `<!-- [section:impact] -->`, and the Bridge Activation card inside `#commsDrawer`.
- **Fields:** `pre.oneLine`, `pre.proof`, `pre.objectPrefill`, `pre.healthy`, `pre.now`, `impact.now`, `impact.future`, `impact.time`, `ops.bridgeOpenedUtc`, `ops.icName`, `ops.bcName`, `ops.semOpsName`, `ops.severity`, `ops.detectMonitoring`, `ops.detectUserReport`, `ops.detectAutomation`, `ops.detectOther`, `ops.evScreenshot`, `ops.evLogs`, `ops.evMetrics`, `ops.evRepro`, `ops.evOther`, `ops.containStatus`, `ops.containDesc`.
- **Notes:** Even though the bridge fields live in the communications drawer, `src/preface.js` owns their serialization via `getPrefaceState()` / `applyPrefaceState()` so that the hero mirror text stays in sync.

### Communications cadence & log (`src/comms.js`)

- **Anchors / DOM roots:** `#commsDrawer` → `#commControlsCard` (cadence radio buttons, log list, and next update input).
- **Fields:** `ops.commCadence`, `ops.commLog`, `ops.commNextDueIso`, `ops.commNextUpdateTime`.
- **Notes:** These values are merged into the `ops` object during `collectAppState()`. The cadence timer also uses `logCommunication()` hooks from `src/comms.js`, so changes to these fields should always flow through that module.

### KT table, focus modes, and hypotheses (`src/kt.js`)

- **Anchors / DOM roots:** `<!-- [section:table] -->` (`#ktTable` and focus buttons) plus `#possibleCausesCard` / `#possible-causes`.
- **Fields:** `table`, `ops.tableFocusMode`, `causes`, `likelyCauseId`.
- **Notes:** `configureKT()` wires auto-resize, cause rendering, and table exports. Any edits to `ops.tableFocusMode` or the serialized table rows must go through `src/kt.js` helpers such as `exportKTTableState()`, `setTableFocusMode()`, and the cause serialization helpers.

### Steps drawer (`src/steps.js`)

- **Anchors / DOM roots:** `#stepsDrawer` (including toolbar and checklist list).
- **Fields:** `steps.drawerOpen`, `steps.items`.
- **Notes:** The drawer manages its own `localStorage` cache for quick reloads but ultimately feeds these fields through `exportStepsState()` / `importStepsState()` whenever the full intake snapshot is saved or loaded.

### Action list card (`components/actions/ActionListCard.js` + `src/actionsStore.js`)

- **Anchors / DOM roots:** Mounted immediately after `#possibleCausesCard` via `mountAfterPossibleCauses()` in `main.js`.
- **Fields:** `actions.analysisId`, `actions.items`.
- **Notes:** The component writes to the dedicated `kt-actions-by-analysis-v1` key and mirrors data into the main snapshot through `exportActionsState()` so Save/Load flows stay portable. `actions.items` should always be generated by `listActions()` / `exportActionsState()`. Each action persists a `risk` object shaped as `{ level, impactIfFails, prevent, ifHappens }`; legacy string values are normalized on load.

### Global metadata (`src/appState.js` + `src/storage.js`)

- **Anchors / DOM roots:** N/A (system-level helpers).
- **Fields:** `meta.version`, `meta.savedAt`, plus the top-level `actions` wrapper object, `ops` object, and `steps` object shells that hold the grouped fields above.
- **Notes:** `collectAppState()` (in `src/appState.js`) assembles the complete payload, sets the schema version, and stamps `meta.savedAt`. Any migration logic or new modules should register with `collectAppState()` / `applyAppState()` so the metadata stays accurate.

### Cross-cutting callouts

- `ops.commLog` is stored under the broader `ops` object but only `src/comms.js` should mutate it—the comms drawer enforces validation and timer side effects tied to each log entry.
- `table` snapshots and `ops.tableFocusMode` both live under the `KT` module; updating them anywhere else risks desynchronizing the question anchors and focus toggle states.
- Possible-cause data (`causes`, `likelyCauseId`) is tightly coupled with the action list card through the cause-linking UI; if you adjust those fields, also review `components/actions/ActionListCard.js` to ensure the card still renders linked hypotheses correctly.
